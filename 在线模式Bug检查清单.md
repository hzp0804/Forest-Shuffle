# 在线模式潜在 Bug 检查清单

## 已修复的问题 ✅

1. ✅ 牌库数量配置修正
2. ✅ 奖励播报优化
3. ✅ 摸牌/拿牌后取消选中
4. ✅ 回合切换事件顺序修复
5. ✅ 切换森林卡顿修复
6. ✅ 玩家列表宽度调整
7. ✅ 添加回合检查
8. ✅ 修复回合切换提示残留
9. ✅ 修复欧洲七叶树详情得分显示

## 需要检查的潜在问题

### 1. 数据同步问题

#### 1.1 回合切换时的状态清理

**检查点**:

- ✅ `primarySelection` - 已清理
- ✅ `selectedSlot` - 已清理
- ✅ `pendingActionToast` - 已清理
- ❓ `selectedClearingIdx` - 需要检查是否在回合切换时清理

**潜在问题**: 如果玩家 A 选中了空地卡牌但没有拿取就结束回合,回合切换到玩家 B 时,选中状态可能残留。

#### 1.2 特殊行动模式的清理

**检查点**:

- `actionMode` - 回合切换时是否清理?
- `pendingActions` - 回合切换时是否清理?

**潜在问题**: 如果玩家 A 在特殊行动中结束回合,模式可能残留到玩家 B。

### 2. 网络延迟问题

#### 2.1 快速连续操作

**场景**: 玩家快速点击出牌按钮
**潜在问题**:

- 可能触发多次出牌
- 需要检查是否有防抖/节流机制

#### 2.2 数据竞态

**场景**: 玩家 A 和玩家 B 同时操作
**潜在问题**:

- 数据库更新冲突
- 需要检查是否有乐观锁或版本控制

### 3. UI 状态问题

#### 3.1 事件队列处理

**检查点**:

- 事件队列是否会无限增长?
- 是否有最大长度限制?
- 处理失败时是否会卡住?

#### 3.2 动画冲突

**场景**: 多个事件同时触发动画
**潜在问题**:

- 动画可能重叠
- UI 可能闪烁

### 4. 边界情况

#### 4.1 牌库耗尽

**场景**: 牌库没有牌了
**检查点**:

- 摸牌时是否检查牌库是否为空?
- 翻牌时是否检查?

#### 4.2 手牌上限

**场景**: 手牌已满(10 张)
**检查点**:

- ✅ 摸牌时有检查
- ❓ 奖励摸牌时是否正确处理?

#### 4.3 空地满了

**场景**: 空地有 10 张牌
**检查点**:

- ✅ 会自动清空
- ❓ 清空时是否正确触发通知?

### 5. 玩家离线/重连

#### 5.1 玩家离线

**场景**: 玩家 A 断网或关闭小程序
**检查点**:

- 游戏是否继续?
- 其他玩家是否能正常游戏?
- 是否有超时机制?

#### 5.2 玩家重连

**场景**: 玩家 A 重新打开小程序
**检查点**:

- 是否能正确恢复游戏状态?
- 是否能看到正确的回合?
- 事件队列是否正确?

### 6. 特殊卡牌逻辑

#### 6.1 堆叠卡牌

**检查点**:

- 欧洲野兔堆叠是否正确?
- 大蟾蜍堆叠是否正确?
- 刺荨麻共享槽位是否正确?

#### 6.2 常驻效果

**检查点**:

- 常驻效果是否在所有情况下都正确触发?
- 是否会重复触发?

#### 6.3 特殊行动

**检查点**:

- 浣熊行动是否正确?
- 鼹鼠行动是否正确?
- 水田鼠树苗模式是否正确?

### 7. 计分系统

#### 7.1 实时计分

**检查点**:

- 分数是否实时更新?
- 是否有性能问题?
- 缓存是否正确?

#### 7.2 特殊计分

**检查点**:

- ✅ 蝴蝶集合计分
- ✅ 欧洲七叶树阶梯计分
- ❓ 紫木蜂虚拟树计分
- ❓ 胡兀鹫洞穴计分

## 建议检查的代码位置

### 1. 回合切换逻辑

**文件**: `miniprogram/pages/game/game.js`
**函数**: `processGameData` 的回合切换部分
**检查**: 是否清理了所有临时状态

### 2. 出牌逻辑

**文件**: `miniprogram/pages/game/game.js`
**函数**: `onConfirmPlay`
**检查**: 是否有防重复点击机制

### 3. 摸牌/拿牌逻辑

**文件**: `miniprogram/pages/game/game.js`
**函数**: `executeDrawFromDeck`, `onConfirmTake`
**检查**: 边界条件处理

### 4. 特殊行动逻辑

**文件**: `miniprogram/utils/specialAction.js`
**检查**: 各种特殊行动的实现

### 5. 计分逻辑

**文件**: `miniprogram/utils/score/`
**检查**: 各种计分类型的实现

## 测试场景建议

### 场景 1: 回合切换状态清理

1. 玩家 A 选中手牌但不出牌
2. 玩家 A 选中空地卡牌但不拿取
3. 玩家 A 点击牌库但不摸牌
4. 玩家 A 结束回合
5. **检查**: 玩家 B 的回合开始时,所有选中状态是否清除?

### 场景 2: 快速操作

1. 玩家 A 快速连续点击"打出"按钮
2. **检查**: 是否只出了一张牌?

### 场景 3: 牌库耗尽

1. 游戏进行到牌库只剩 1 张牌
2. 玩家 A 摸牌
3. **检查**: 牌库为空时,玩家 B 能否正常操作?

### 场景 4: 手牌满了

1. 玩家 A 手牌已有 10 张
2. 玩家 A 出牌触发奖励摸 2 张牌
3. **检查**: 是否正确处理?只摸能摸的数量?

### 场景 5: 特殊行动中断

1. 玩家 A 触发特殊行动(如免费打牌)
2. 玩家 A 点击"跳过"
3. **检查**: 是否正确清理状态?

### 场景 6: 多人同时操作

1. 玩家 A 的回合
2. 玩家 B 尝试点击手牌/空地/牌库
3. **检查**: ✅ 已添加回合检查,应该会提示"不是你的回合"

### 场景 7: 玩家离线

1. 玩家 A 关闭小程序
2. 玩家 B 继续游戏
3. **检查**: 游戏是否正常进行?

### 场景 8: 玩家重连

1. 玩家 A 关闭小程序
2. 等待几个回合
3. 玩家 A 重新打开
4. **检查**: 是否能看到正确的游戏状态?

## 优先级排序

### 高优先级 🔴

1. 回合切换时 `selectedClearingIdx` 的清理
2. 出牌按钮的防重复点击
3. 特殊行动模式的回合切换清理

### 中优先级 🟡

1. 牌库耗尽的边界处理
2. 事件队列的长度限制
3. 玩家离线/重连处理

### 低优先级 🟢

1. 动画冲突优化
2. 性能优化
3. 错误提示优化
