# 卡牌堆叠功能修复

## 问题

阿尔卑斯旱獭无法堆叠,虽然配置了 `CAPACITY_UNLIMITED` 效果。

## 根本原因

**名字不匹配**:

- `SPECIES_NAMES.MARMOTA_MARMOTA` 的值是 `"阿尔卑斯旱獭"`
- 但 `speciesData.js` 中卡牌的 `name` 是 `"高山旱獭"`

堆叠逻辑需要检查:

```javascript
existingCard.name === checkName; // "阿尔卑斯旱獭" !== "高山旱獭" ❌
```

## 修复方案

将卡牌的 `name` 从 `"高山旱獭"` 改为 `"阿尔卑斯旱獭"`,与常量定义保持一致。

### 修改前:

```javascript
[SPECIES_NAMES.MARMOTA_MARMOTA]: {
  name: "高山旱獭",  // ❌ 与常量不一致
  effect: "该槽位可以容纳任意数量的高山旱獭",
  effectConfig: {
    type: MODIFIER_TYPES.CAPACITY_UNLIMITED,
    target: SPECIES_NAMES.MARMOTA_MARMOTA  // "阿尔卑斯旱獭"
  },
  points: "每有一只高山旱獭获得2分",
}
```

### 修改后:

```javascript
[SPECIES_NAMES.MARMOTA_MARMOTA]: {
  name: "阿尔卑斯旱獭",  // ✅ 与常量一致
  effect: "该槽位可以容纳任意数量的阿尔卑斯旱獭",
  effectConfig: {
    type: MODIFIER_TYPES.CAPACITY_UNLIMITED,
    target: SPECIES_NAMES.MARMOTA_MARMOTA  // "阿尔卑斯旱獭"
  },
  points: "每有一只阿尔卑斯旱獭获得2分",
}
```

## 堆叠逻辑说明

### 公共逻辑 (已存在)

所有使用 `CAPACITY_UNLIMITED` 或 `CAPACITY_INCREASE` 的卡牌都共用同一套堆叠逻辑:

#### 在 `onSlotTap` 中:

```javascript
// (1) 同名堆叠
if (existingCard.name === checkName) {
  if (
    existingCard.effectConfig?.type === "CAPACITY_UNLIMITED" &&
    existingCard.effectConfig.target === checkName
  ) {
    allowStack = true;
    capacity = 999;
  }
}
```

#### 在 `onConfirmPlay` 中:

```javascript
const ec = existingCard.effectConfig;
const targetName = primaryCard.name;
const isCapacityUnlimited =
  ec && ec.type === "CAPACITY_UNLIMITED" && ec.target === targetName;
const isSelfStacking = isCapacityUnlimited;
```

### 支持的卡牌

只要配置正确,以下卡牌都能自动堆叠:

1. **欧洲野兔** ✅

   - `name: "欧洲野兔"`
   - `target: SPECIES_NAMES.EUROPEAN_HARE` → `"欧洲野兔"`
   - 容量: 无限

2. **阿尔卑斯旱獭** ✅ (已修复)

   - `name: "阿尔卑斯旱獭"`
   - `target: SPECIES_NAMES.MARMOTA_MARMOTA` → `"阿尔卑斯旱獭"`
   - 容量: 无限

3. **大蟾蜍** ✅
   - `name: "大蟾蜍"`
   - `target: SPECIES_NAMES.COMMON_TOAD` → `"大蟾蜍"`
   - `type: CAPACITY_INCREASE`
   - 容量: 2

## 关键要点

### 1. 名字必须一致

```javascript
// ✅ 正确
SPECIES_NAMES.XXX = "卡牌A";
speciesData: {
  name: "卡牌A";
}

// ❌ 错误
SPECIES_NAMES.XXX = "卡牌A";
speciesData: {
  name: "卡牌B";
} // 不一致!
```

### 2. target 必须指向自己

```javascript
effectConfig: {
  type: MODIFIER_TYPES.CAPACITY_UNLIMITED,
  target: SPECIES_NAMES.XXX  // 必须是自己的常量名
}
```

### 3. 验证逻辑

堆叠验证会检查:

1. `existingCard.name === checkName` (同名)
2. `existingCard.effectConfig.target === checkName` (target 匹配)
3. 两个条件都满足才允许堆叠

## 测试建议

### 测试阿尔卑斯旱獭堆叠:

1. 打出第一只阿尔卑斯旱獭到某个槽位
2. 尝试在同一槽位打出第二只阿尔卑斯旱獭
3. 检查是否成功堆叠
4. 继续打出第三只、第四只
5. 检查计分是否正确(每只 2 分)

### 测试欧洲野兔堆叠:

1. 打出第一只欧洲野兔
2. 在同一槽位打出更多欧洲野兔
3. 检查堆叠和计分

### 测试大蟾蜍堆叠:

1. 打出第一只大蟾蜍
2. 在同一槽位打出第二只大蟾蜍
3. 尝试打出第三只,应该提示"插槽已满"
4. 检查计分(2 只共享槽位得 5 分)
