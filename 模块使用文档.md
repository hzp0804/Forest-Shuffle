# 模块使用文档

本文档详细说明了 `miniprogram/pages/game/modules/` 目录下各个模块的用途和 API 调用方式。

## 1. 核心模块

### core.js

处理游戏核心逻辑，如状态更新和事件创建。

- **submitGameUpdate(page, updates, successMsg, logMsg)**

  - 提交游戏数据更新到云数据库，并更新本地 optimistic state。
  - `page`: 页面实例
  - `updates`: 要更新的数据对象
  - `successMsg`: 成功提示 (Toast)
  - `logMsg`: 日志记录信息

- **createPlayerEvent(page, type, data)**
  - 创建一个包含玩家基础信息 (头像、昵称) 的事件对象。

### watcher.js

负责云数据库的实时监听。

- **initGameWatcher(page)**
  - 初始化监听器。通常在 `onLoad` 或 `onShow` 调用。
- **stopWatcher(page)**
  - 停止监听及清理资源。在 `onHide` 或 `onUnload` 调用。

### events.js

管理事件队列和动画播放。

- **processNextEvent(page)**
  - 递归处理事件队列中的下一个事件，控制动画播放节奏。
- **addToEventQueue(page, event)**
  - 将新事件添加到队列末尾。

## 2. 游戏逻辑模块

### draw.js

处理抽牌相关逻辑。

- **processDrawWithWinter(page, deck, count, startWinterCount)**
  - 处理抽牌，自动检测冬季卡，返回处理后的牌堆、抽到的牌及事件。
- **executeDrawFromDeck(page)**
  - 执行具体的抽牌动作，包含调用 `processDrawWithWinter` 和提交更新。

### play.js

基础出牌逻辑。

- **onConfirmTake(page)**
  - 处理玩家从空地拿牌的逻辑。

### playNormal.js

普通出牌逻辑的核心实现。

- **preparePlayData(page)**
  - 从页面数据中提取出牌所需的上下文 (手牌、费牌、森林状态等)。
- **placeCardInForest(forest, primaryCard, selectedSlot, isTree)**
  - 将卡片放入森林的逻辑，处理树木放置和插槽堆叠规则。

### playReward.js

奖励计算模块。

- **calculatePlayRewards(page, primaryCard, selectedSlot, paymentCards, forest, source, gameState)**
  - 计算打出某张牌后的 Bonus (奖励)、Effect (效果) 和 Trigger (触发器)。
  - 返回 `{ bonus, effect, triggers, reward }`。

### playSpecial.js

处理特定卡牌触发的特殊行动模式。

- **handleTuckAction(page)**
  - 处理大蟾蜍等需要将手牌叠放在下方的行动。
- **handleRaccoonAction(page)**
  - 处理浣熊行动 (从空地拿牌放洞穴/手牌)。
- **handleClearingPickAction(page)**
  - 处理从空地拿牌的其他特殊效果 (如蝙蝠、蚊子)。

### sapling.js

处理树苗相关逻辑。

- **onPlaySapling(page)**
  - 验证并确认打出树苗。
- **executePlaySapling(page)**
  - 执行打出树苗的实际逻辑 (扣除手牌、计算奖励、更新数据库)。

### action.js

处理行动结束和回合流转。

- **finalizeAction(page, actionUpdates, logMsg)**
  - 结束当前的特殊行动模式，结算累积奖励 (如摸牌数)，并根据情况结束回合或继续。
- **onEndTurn(page)**
  - 玩家主动结束回合。

## 3. 交互模块

### interaction.js

处理用户点击和触摸事件。

- **onHandTap(page, e)**
- **onSlotTap(page, e)**
- **onPlayerTap(page, e)**
- **onStackTap(page, e)**
- **onClearingCardTap(page, e)**

### display.js

处理界面显示逻辑。

- **onShowDetail(page, e)**
- **onShowBuffs(page)**
- **onForestSwiperChange(page, e)**

## 4. 如何在主文件中使用

在 `game.js` 中引入索引文件：

```javascript
const GameModules = require("./modules/index.js");

Page({
  // 将原有逻辑替换为模块调用
  onHandTap(e) {
    GameModules.onHandTap(this, e);
  },

  async onConfirmPlay(e) {
    // 根据 gameState.actionMode 路由到不同的处理模块
    // ...
  },
});
```
