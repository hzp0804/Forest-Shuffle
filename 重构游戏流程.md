# Game.js 重构计划

## 目标

将超大的 `game.js` 文件(2577 行,102KB)拆分成多个小模块,提高代码可维护性和可读性。

## 模块划分

### 1. core.js (4.3KB)

**职责**: 核心功能和工具函数

- `submitGameUpdate()` - 提交游戏状态更新到数据库
- `createPlayerEvent()` - 创建带玩家信息的事件对象
- `createExtraTurnEvent()` - 创建额外回合事件
- `createClearingNotification()` - 创建清空空地通知

### 2. watcher.js (6.8KB)

**职责**: 实时数据监听和同步

- `initGameWatcher()` - 初始化云数据库实时监听
- `stopWatcher()` - 停止监听
- `processGameUpdate()` - 处理服务器推送的游戏数据更新

### 3. draw.js (4.5KB)

**职责**: 抽牌相关逻辑

- `processDrawWithWinter()` - 处理抽牌逻辑(包含冬季卡检测)
- `executeDrawFromDeck()` - 从牌堆抽牌

### 4. interaction.js (12.6KB)

**职责**: 用户交互处理

- `onPlayerTap()` - 玩家头像点击
- `onHandTap()` - 手牌点击
- `onSlotTap()` - 森林槽位点击
- `onStackTap()` - 堆叠卡片点击
- `onClearingCardTap()` - 空地卡片点击
- `onToggleHandExpanded()` - 手牌展开/收起
- `onHandTouchStart()` / `onHandTouchEnd()` - 手牌滑动手势
- `onDrawCard()` - 牌库点击

### 5. action.js (11.9KB)

**职责**: 特殊行动处理

- `onConfirmSpecialAction()` - 确认执行特殊行动
- `finalizeAction()` - 结束特殊行动模式,执行累积奖励
- `onEndTurn()` - 结束回合

### 6. play.js (2.7KB)

**职责**: 基础出牌和拿牌

- `onConfirmTake()` - 从空地拿牌

### 7. events.js (3.1KB)

**职责**: 事件队列和动画

- `addToEventQueue()` - 添加事件到队列
- `processNextEvent()` - 处理下一个事件
- `onCloseEvent()` - 关闭当前事件

### 8. display.js (5.1KB)

**职责**: 显示相关功能

- `onShowDetail()` - 显示卡片详情
- `onCloseDetail()` - 关闭卡片详情
- `onShowBuffs()` - 显示森林常驻效果
- `onForestSwiperChange()` - 森林区域滑动切换

### 9. cheat.js (1.5KB)

**职责**: 调试/金手指功能

- `onCheatAddCards()` - 打开金手指面板
- `closeCheatModal()` - 关闭金手指面板
- `onCheatCardSelect()` - 选择金手指卡片
- `onCheatCardPreview()` - 预览金手指卡片

### 10. sapling.js (6.9KB)

**职责**: 树苗打出逻辑

- `onPlaySapling()` - 打出树苗
- `executePlaySapling()` - 执行打出树苗

### 11. index.js (1.1KB)

**职责**: 模块统一导出

- 导出所有模块的函数,方便主文件引用

## 待处理的大函数

### onConfirmPlay() - 超大函数(~840 行)

这是最复杂的函数,需要进一步拆分:

**建议拆分方案**:

1. **confirmPlay.js** - 主流程控制
2. **playTuck.js** - 大蟾蜍叠放逻辑
3. **playRaccoon.js** - 浣熊行动逻辑
4. **playClearing.js** - 从空地拿牌到手/洞穴
5. **playNormal.js** - 普通出牌流程
6. **playSpecial.js** - 特殊模式出牌(鼼鼠/树苗/免费打牌)
7. **playReward.js** - 奖励计算和处理
8. **playValidation.js** - 出牌校验逻辑

## 下一步行动

1. ✅ 创建基础模块(core, watcher, draw 等)
2. ✅ 创建交互模块(interaction)
3. ✅ 创建行动模块(action)
4. ✅ 创建辅助模块(events, display, cheat, sapling)
5. ⏳ 拆分 onConfirmPlay 函数
6. ⏳ 重构主 game.js 文件,使用模块化导入
7. ⏳ 测试所有功能是否正常

## 预期效果

- **主文件大小**: 从 2577 行 减少到 ~500 行
- **模块化**: 每个模块职责单一,易于维护
- **可测试性**: 独立模块更容易进行单元测试
- **可读性**: 代码结构清晰,新人更容易理解
