# 水田鼠功能实现总结

## 需求

水田鼠的效果:"立即打出任意数量的树苗"

- 只能通过点击"树苗"按钮来打出树苗
- 不需要先选择手牌
- 可以无限次打出,直到玩家点击"跳过"

## 实现内容

### 1. UI 调整 (`miniprogram/pages/game/game.wxml`)

**在水田鼠模式(ACTION_PLAY_SAPLINGS)下:**

- ❌ 隐藏"拿取"按钮
- ❌ 隐藏"打出"按钮
- ✅ 只显示"树苗"按钮,并且启用它

**按钮逻辑:**

```xml
<!-- 拿取按钮:水田鼠模式下隐藏 -->
<block wx:if="{{!gameState.actionMode && gameState.actionMode !== 'ACTION_PLAY_SAPLINGS'}}">
  <button bindtap="onConfirmTake">✋拿取</button>
</block>

<!-- 打出按钮:水田鼠模式下隐藏 -->
<button wx:if="{{gameState.actionMode !== 'ACTION_PLAY_SAPLINGS'}}" bindtap="onConfirmPlay">
  ✅打出
</button>

<!-- 树苗按钮:水田鼠模式下启用 -->
<button disabled="{{gameState.actionMode && gameState.actionMode !== 'ACTION_PLAY_SAPLINGS'}}" bindtap="onPlaySapling">
  🌱树苗
</button>
```

### 2. 打出树苗逻辑 (`miniprogram/pages/game/game.js`)

#### 2.1 `onPlaySapling` 函数修改

**普通模式:**

1. 需要先选择一张手牌
2. 弹出确认对话框
3. 确认后执行 `executePlaySapling`
4. 结束回合

**水田鼠模式:**

1. 不需要先选择手牌
2. 自动选择第一张手牌
3. 直接执行 `executePlaySapling`,不需要确认
4. **不结束回合**,继续保持在水田鼠模式

```javascript
onPlaySapling() {
  const { gameState, playerStates, openId } = this.data;

  // 水田鼠模式下的特殊处理
  if (gameState && gameState.actionMode === 'ACTION_PLAY_SAPLINGS') {
    const myHand = playerStates[openId]?.hand || [];
    if (myHand.length === 0) {
      wx.showToast({ title: "手牌为空", icon: "none" });
      return;
    }

    // 自动选择第一张手牌
    const firstCard = myHand[0];
    this.setData({ primarySelection: firstCard.uid });

    // 直接执行打出树苗,不需要确认
    this.executePlaySapling();
    return;
  }

  // 普通模式:需要先选择手牌并确认
  // ...
}
```

#### 2.2 `executePlaySapling` 函数修改

**关键修改:**

- 检测是否在水田鼠模式下
- 水田鼠模式下:
  - 不切换玩家(`activePlayer` 保持当前玩家)
  - 不增加回合计数(`turnCount` 不变)
  - 不重置回合行动(`turnAction` 不变)
  - 保持 `ACTION_PLAY_SAPLINGS` 模式(不清除 `actionMode`)

```javascript
async executePlaySapling() {
  // ... 前面的逻辑不变 ...

  // 检查是否在水田鼠模式下
  const isWaterVoleMode = this.data.gameState && this.data.gameState.actionMode === 'ACTION_PLAY_SAPLINGS';

  // 水田鼠模式下不切换玩家
  const nextPlayer = isWaterVoleMode ? openId : RoundUtils.getNextPlayer(openId, this.data.players, reward.extraTurn);

  const updates = {
    [`gameState.playerStates.${openId}.hand`]: DbHelper.cleanHand(newHand),
    [`gameState.playerStates.${openId}.forest`]: DbHelper.cleanForest(forest),
    // ... 其他更新 ...
  };

  // 水田鼠模式下:不结束回合
  if (!isWaterVoleMode) {
    updates[`gameState.turnAction`] = { drawnCount: 0, takenCount: 0 };
    updates[`gameState.turnCount`] = db.command.inc(1);
    updates[`gameState.turnReason`] = reward.extraTurn ? "extra" : "normal";
  }

  // 清除本地选择状态,准备下一次打出
  this.setData({ primarySelection: null });

  this.submitGameUpdate(updates, "种植成功", isWaterVoleMode ? "打出树苗(水田鼠模式)" : "将一张手牌作为树苗打出");
}
```

### 3. 验证逻辑 (`miniprogram/utils/validate.js`)

**已实现:**

- 水田鼠模式下不显示原卡牌的奖励和效果
- 因为卡牌会被转换为树苗,原有的奖励和效果不会触发

## 工作流程

### 水田鼠模式流程:

1. 玩家打出水田鼠,触发 `ACTION_PLAY_SAPLINGS` 模式
2. UI 自动调整:隐藏"拿取"和"打出"按钮,只显示"树苗"按钮
3. 玩家点击"树苗"按钮
4. 系统自动选择第一张手牌
5. 卡牌被转换为树苗并放入森林
6. **保持在水田鼠模式**,玩家可以继续点击"树苗"按钮
7. 重复步骤 3-6,直到玩家点击"跳过"按钮
8. 点击"跳过"后,清除 `ACTION_PLAY_SAPLINGS` 模式,结束特殊行动

### 普通树苗流程:

1. 玩家选择一张手牌
2. 点击"树苗"按钮
3. 弹出确认对话框
4. 确认后,卡牌被转换为树苗并放入森林
5. 结束回合,切换到下一个玩家

## 与鼹鼠的区别

| 特性      | 鼹鼠 (ACTION_MOLE)    | 水田鼠 (ACTION_PLAY_SAPLINGS)  |
| --------- | --------------------- | ------------------------------ |
| 打出方式  | 选择手牌 + 点击"打出" | 点击"树苗"按钮                 |
| 卡牌类型  | 任何牌                | 只能打树苗(任何牌都转换为树苗) |
| 费用验证  | 需要支付费用          | 不需要(树苗费用为 0)           |
| 奖励/效果 | 会触发                | 不会触发(转换为树苗)           |
| 次数限制  | 无限次                | 无限次                         |
| UI 显示   | 显示所有按钮          | 只显示"树苗"按钮               |

## 测试建议

### 测试场景:

1. 打出水田鼠,检查是否进入 `ACTION_PLAY_SAPLINGS` 模式
2. 检查 UI 是否只显示"树苗"按钮
3. 点击"树苗"按钮,检查是否自动选择第一张手牌并打出
4. 检查打出的卡牌是否变成树苗
5. 检查是否仍然在水田鼠模式,可以继续打出树苗
6. 连续打出多张树苗
7. 点击"跳过"按钮,检查是否退出水田鼠模式
8. 检查是否正确触发后续的奖励(如摸牌、额外回合等)
