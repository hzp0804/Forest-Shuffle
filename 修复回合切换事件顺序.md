# 修复回合切换事件显示顺序

## 问题描述

在多人联机模式下,事件播报的顺序有问题:

- ❌ **错误顺序**: 先显示"轮到 XXX"的回合切换提示,然后才显示上一回合的操作(出牌、摸牌等)
- ✅ **正确顺序**: 应该先显示上一回合的所有操作,最后才显示回合切换提示

这导致玩家体验混乱,看不清上一个玩家做了什么就已经切换到下一回合了。

## 问题原因

### 事件创建时机

1. **TURN_CHANGE 事件**: 在客户端检测到回合切换时创建,使用 `Date.now()`
2. **其他事件**(lastEvent, rewardDrawEvent 等): 在服务器端创建,也使用 `Date.now()`

### 时间戳问题

由于网络延迟和处理顺序:

- 客户端检测到回合切换时,`TURN_CHANGE`事件被立即创建
- 此时上一回合的事件可能还在数据库中,timestamp 可能更早
- 但由于`TURN_CHANGE`在客户端创建时使用的是当前时间,可能比服务器事件的时间更新
- 导致事件队列排序时,`TURN_CHANGE`排在前面

### 事件队列处理逻辑

```javascript
// 第236-243行: 按timestamp添加事件
const tryAddEvent = (evt) => {
  if (evt && evt.timestamp > nextLastEventTime) {
    this.addToEventQueue(evt);
    nextLastEventTime = Math.max(nextLastEventTime, evt.timestamp);
    added = true;
  }
};
```

事件按 timestamp 从小到大排序,timestamp 越小越先显示。

## 解决方案

给`TURN_CHANGE`事件添加一个较大的 timestamp 偏移(+1000ms),确保它的 timestamp 一定大于上一回合的所有事件。

### 修改位置

**文件**: `miniprogram/pages/game/game.js`  
**行数**: 第 215 行

### 修改前

```javascript
timestamp: Date.now();
```

### 修改后

```javascript
timestamp: Date.now() + 1000; // 添加偏移,确保回合切换事件在上一回合的所有事件之后显示
```

## 原理说明

### 时间轴示例

#### 修改前(错误顺序)

```
t=1000: [客户端] 检测到回合切换,创建TURN_CHANGE事件 (timestamp=1000)
t=950:  [服务器] 上一回合的PLAY_CARD事件 (timestamp=950)
t=960:  [服务器] 上一回合的REWARD_DRAW事件 (timestamp=960)

事件队列: [PLAY_CARD(950), REWARD_DRAW(960), TURN_CHANGE(1000)]
显示顺序: PLAY_CARD → REWARD_DRAW → TURN_CHANGE ✅

但实际情况可能是:
t=1000: [客户端] TURN_CHANGE (timestamp=1000)
t=1050: [服务器] PLAY_CARD到达客户端 (timestamp=1050)

事件队列: [TURN_CHANGE(1000), PLAY_CARD(1050)]
显示顺序: TURN_CHANGE → PLAY_CARD ❌ (错误!)
```

#### 修改后(正确顺序)

```
t=1000: [客户端] 检测到回合切换,创建TURN_CHANGE事件 (timestamp=2000, 即1000+1000)
t=1050: [服务器] PLAY_CARD到达客户端 (timestamp=1050)

事件队列: [PLAY_CARD(1050), TURN_CHANGE(2000)]
显示顺序: PLAY_CARD → TURN_CHANGE ✅ (正确!)
```

### 为什么选择+1000ms?

- 正常情况下,一个回合的所有事件(出牌、摸牌、翻牌等)的 timestamp 差距不会超过 1000ms
- +1000ms 的偏移足够大,确保`TURN_CHANGE`一定排在最后
- 不会太大,避免事件显示延迟过长

## 效果

### 修改前

```
播报顺序:
1. 🎯 轮到你了!              ← 回合切换
2. 玩家A 打出了 XXX卡        ← 上一回合操作
3. 玩家A 奖励摸2张牌         ← 上一回合操作
```

### 修改后

```
播报顺序:
1. 玩家A 打出了 XXX卡        ← 上一回合操作
2. 玩家A 奖励摸2张牌         ← 上一回合操作
3. 🎯 轮到你了!              ← 回合切换
```

## 测试场景

### 场景 1: 正常出牌

1. 玩家 A 出牌
2. 触发奖励摸牌
3. 回合切换到玩家 B
4. **预期**: 先显示出牌和摸牌,最后显示"轮到玩家 B" ✅

### 场景 2: 额外回合

1. 玩家 A 出牌触发额外回合
2. 额外回合提示
3. 仍然是玩家 A 的回合
4. **预期**: 先显示出牌,再显示额外回合提示 ✅

### 场景 3: 多个事件

1. 玩家 A 出牌
2. 触发常驻效果摸牌
3. 翻牌到空地
4. 回合切换
5. **预期**: 按顺序显示所有操作,最后才显示回合切换 ✅
