# 出牌动画展示奖励和效果 - 最终版本

## 需求

在出牌时,如果触发奖励或者效果,需要在出牌动画中展示具体内容,让玩家清楚地看到打出这张牌获得了什么。

## 实现内容

### 1. 增强 `calculateTriggerEffects` 函数 (`miniprogram/utils/reward.js`)

- 添加 `triggers` 数组,记录每个触发效果的详细信息
- 每个触发效果包含:
  - `cardName`: 触发效果的卡牌名称
  - `text`: 效果描述(如"摸 2 张牌")

### 2. 修改 `PLAY_CARD` 事件数据 (`miniprogram/pages/game/game.js`)

在三个创建 `PLAY_CARD` 事件的地方添加奖励和效果信息:

- **`bonusText`**: 使用 `primaryCard.bonus` (物种数据中的原始文本)
- **`effectText`**: 使用 `primaryCard.effect` (物种数据中的原始文本)
- **`triggers`**: 触发效果列表(如 `[{cardName: "鸡油菌", text: "摸1张牌"}]`)

**重要**: 直接使用物种数据中的 `bonus` 和 `effect` 字段,而不是 `calculateReward` 生成的文本。

```javascript
[`gameState.lastEvent`]: {
  type: 'PLAY_CARD',
  playerOpenId: openId,
  playerNick: ...,
  playerAvatar: ...,
  mainCard: primaryCard,
  subCards: paymentCards.map(c => Utils.enrichCard(c)),
  // 使用物种数据中的原始文本
  bonusText: primaryCard.bonus || null,
  effectText: primaryCard.effect || null,
  triggers: triggers.triggers || [],
  timestamp: Date.now()
}
```

### 3. 更新 WXML 模板 (`miniprogram/pages/game/game.wxml`)

在 `PLAY_CARD` 事件展示区域添加奖励信息显示:

```xml
<view class="reward-info" wx:if="{{currentEvent.bonusText || currentEvent.effectText || (currentEvent.triggers && currentEvent.triggers.length > 0)}}">
  <!-- 奖励优先显示,用绿色 -->
  <view wx:if="{{currentEvent.bonusText}}" style="color: #90EE90;">
    <text>🎁</text>
    <text>奖励: {{currentEvent.bonusText}}</text>
  </view>

  <!-- 效果用蓝色 -->
  <view wx:if="{{currentEvent.effectText}}" style="color: #87CEEB;">
    <text>✨</text>
    <text>效果: {{currentEvent.effectText}}</text>
  </view>

  <!-- 触发效果用金色 -->
  <block wx:if="{{currentEvent.triggers && currentEvent.triggers.length > 0}}">
    <view wx:for="{{currentEvent.triggers}}" wx:key="index" style="color: #FFD700;">
      <text>⚡</text>
      <text>触发【{{item.cardName}}】: {{item.text}}</text>
    </view>
  </block>
</view>
```

**显示顺序**: 奖励 → 效果 → 触发效果(从上到下)

**颜色方案**:

- 🎁 **奖励**: **绿色** (#90EE90) - 最重要,优先显示
- ✨ **效果**: **蓝色** (#87CEEB) - 次要
- ⚡ **触发**: **金色** (#FFD700) - 常驻效果触发

### 4. Bug 修复 (`miniprogram/utils/reward.js`)

- 删除了第 21 行不完整的代码 `if (!isBonus) result`
- 这个 bug 可能导致某些情况下奖励计算异常

## 显示效果示例

### 示例 1: 瑞士石松 (同时有奖励和效果)

```
🎁 奖励: 获得1张牌 (绿色)
✨ 效果: 获得1张牌 (蓝色)
```

### 示例 2: 冷杉 (只有奖励)

```
🎁 奖励: 获得新的回合 (绿色)
```

### 示例 3: 渡鸦 (只有效果)

```
✨ 效果: 获得1张牌 (蓝色)
```

### 示例 4: 打出树木时触发鸡油菌

```
⚡ 触发【鸡油菌】: 摸1张牌 (金色)
```

### 示例 5: 高山火绒草 (奖励+效果+触发)

假设森林中有鸡油菌:

```
🎁 奖励: 获得1张牌 (绿色)
✨ 效果: 获得1张牌 (蓝色)
⚡ 触发【鸡油菌】: 摸1张牌 (金色)
```

## 数据流程

1. **计算奖励和效果**:

   ```javascript
   const bonus = calculateReward(
     primaryCard,
     selectedSlot,
     paymentCards,
     {},
     true
   );
   const effect = calculateReward(
     primaryCard,
     null,
     paymentCards,
     { forest },
     false
   );
   const triggers = calculateTriggerEffects(forest, primaryCard, {
     slot: selectedSlot,
   });
   ```

2. **创建事件**:

   ```javascript
   bonusText: primaryCard.bonus || null,  // 直接使用物种数据
   effectText: primaryCard.effect || null, // 直接使用物种数据
   triggers: triggers.triggers || []       // 使用计算的触发效果
   ```

3. **UI 展示**:
   - 检查 `bonusText`、`effectText`、`triggers` 是否有值
   - 按顺序显示,使用对应的颜色和图标

## 注意事项

1. **奖励触发条件**: 奖励需要颜色匹配才会触发(棕熊除外)

   - 如果颜色不匹配,`bonus` 计算结果为空,但 `primaryCard.bonus` 仍然有值
   - UI 会显示奖励文本,但实际不会获得奖励
   - **建议**: 可以根据 `bonus.drawCount` 或 `bonus.extraTurn` 来判断是否真正触发

2. **效果触发条件**: 效果不需要颜色匹配,总是触发

3. **触发效果**: 森林中其他卡牌的常驻效果,根据条件自动触发

## 测试建议

### 测试场景:

1. 打出有奖励的卡牌(如冷杉),检查是否显示"🎁 奖励: 获得新的回合"(绿色)
2. 打出有效果的卡牌(如渡鸦),检查是否显示"✨ 效果: 获得 1 张牌"(蓝色)
3. 打出同时有奖励和效果的卡牌(如瑞士石松),检查是否同时显示奖励和效果,且奖励在上
4. 在森林中有鸡油菌的情况下打出树木,检查是否显示"⚡ 触发【鸡油菌】: 摸 1 张牌"(金色)
5. 测试颜色不匹配的情况,检查奖励是否仍然显示(虽然不会真正触发)
