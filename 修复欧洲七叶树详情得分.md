# 修复欧洲七叶树详情得分显示

## 问题描述

欧洲七叶树的详情弹窗显示的是所有欧洲七叶树的总得分,而不是单张卡牌的得分,导致用户困惑。

## 问题原因

### 欧洲七叶树的计分规则

```javascript
scoreConfig: {
  type: SCORING_TYPES.SCALE_BY_COUNT,
  target: SPECIES_NAMES.HORSE_CHESTNUT,
  scale: {
    1: 1, 2: 4, 3: 9, 4: 16, 5: 25, 6: 36, 7: 49
  }
}
```

**规则**: 根据欧洲七叶树的数量,按阶梯表获得分数。

### 计分逻辑 (handleScaleByCount)

```javascript
// 只有 UID 最小的那张卡负责计算总分,其他卡得0分
if (matchingCards.length > 0 && card.uid === matchingCards[0].uid) {
  // 计算所有欧洲七叶树的总分
  return totalScore; // 例如: 3棵树 = 9分
}
return 0; // 其他卡得0分
```

**问题**:

- Leader 卡显示总分(9 分)
- 其他卡显示 0 分
- 用户期望看到的是"这张卡贡献的分数"

### 示例场景

```
玩家有3棵欧洲七叶树:
- 总得分: 9分 (根据阶梯表)
- Leader卡详情显示: 9分 ❌ (应该显示平均3分)
- 其他卡详情显示: 0分 ❌ (应该显示平均3分)
```

## 解决方案

在卡牌详情组件中,为 `SCALE_BY_COUNT` 类型添加特殊处理:显示平均每张的得分。

### 修改位置

**文件**: `miniprogram/components/card-detail/card-detail.js`  
**函数**: `calculateScore`  
**行数**: 第 128-182 行

### 修改逻辑

#### 1. 检测 SCALE_BY_COUNT 类型

```javascript
const { SCORING_TYPES } = require("../../data/enums");

const isScaleByCount =
  cardData.scoreConfig &&
  cardData.scoreConfig.type === SCORING_TYPES.SCALE_BY_COUNT;
```

#### 2. 计算平均得分

```javascript
if (isScaleByCount) {
  // 找到所有同名卡
  const targetName = cardData.scoreConfig.target || cardData.name;
  const matchingCards = allCards.filter((c) => c.name === targetName);

  if (matchingCards.length > 0) {
    // 找到 Leader (UID 最小)
    matchingCards.sort((a, b) => (a.uid > b.uid ? 1 : -1));
    const leader = matchingCards[0];

    // 用 Leader 计算总分
    const totalScore = handleScaleByCount(
      leader,
      gameContext,
      null,
      null,
      stats
    );

    // 显示平均每张的得分
    score = Math.floor(totalScore / matchingCards.length);
  }
}
```

### 为什么用平均值?

#### 方案对比

**方案 1: 显示总分** (修改前)

- Leader 卡: 9 分
- 其他卡: 0 分
- ❌ 不直观,用户困惑

**方案 2: 显示边际贡献**

- 第 1 张: 1 分 (1→1)
- 第 2 张: 3 分 (1→4)
- 第 3 张: 5 分 (4→9)
- ❌ 复杂,需要排序和计算差值

**方案 3: 显示平均值** (修改后) ✅

- 每张: 3 分 (9÷3)
- ✅ 简单直观
- ✅ 所有卡显示一致

## 效果对比

### 修改前

```
3棵欧洲七叶树:
- 卡片A (Leader): 详情显示 9分 ❌
- 卡片B: 详情显示 0分 ❌
- 卡片C: 详情显示 0分 ❌
- 总分: 9分 ✅
```

### 修改后

```
3棵欧洲七叶树:
- 卡片A: 详情显示 3分 ✅
- 卡片B: 详情显示 3分 ✅
- 卡片C: 详情显示 3分 ✅
- 总分: 9分 ✅
```

## 其他受影响的卡牌

### 萤火虫 (如果有的话)

如果萤火虫也使用 `SCALE_BY_COUNT`,同样会受益于这个修复。

### 蝴蝶 (保持不变)

蝴蝶使用 `BUTTERFLY_SET` 类型,已有特殊处理,显示所有蝴蝶的总分。这是合理的,因为蝴蝶的计分逻辑是"集合收集",所有蝴蝶作为一个整体计分。

## 计算示例

### 示例 1: 3 棵欧洲七叶树

```
数量: 3
阶梯表: { 1: 1, 2: 4, 3: 9, ... }
总分: 9分
平均: 9 ÷ 3 = 3分
详情显示: 3分 ✅
```

### 示例 2: 5 棵欧洲七叶树

```
数量: 5
阶梯表: { ..., 5: 25, ... }
总分: 25分
平均: 25 ÷ 5 = 5分
详情显示: 5分 ✅
```

### 示例 3: 1 棵欧洲七叶树

```
数量: 1
阶梯表: { 1: 1, ... }
总分: 1分
平均: 1 ÷ 1 = 1分
详情显示: 1分 ✅
```

### 示例 4: 7 棵欧洲七叶树

```
数量: 7
阶梯表: { ..., 7: 49 }
总分: 49分
平均: 49 ÷ 7 = 7分
详情显示: 7分 ✅
```

## 特殊处理总结

现在卡牌详情组件有两种特殊处理:

### 1. 蝴蝶 (BUTTERFLY_SET)

- **显示**: 所有蝴蝶的总得分
- **原因**: 蝴蝶是集合收集,作为整体计分
- **示例**: 3 种蝴蝶 = 6 分 (显示 6 分)

### 2. 欧洲七叶树 (SCALE_BY_COUNT)

- **显示**: 平均每张的得分
- **原因**: 每张卡都有贡献,显示平均值更直观
- **示例**: 3 棵树总分 9 分 (显示 3 分)

## 代码结构

```javascript
calculateScore() {
  // ...

  if (isButterfly) {
    // 显示所有蝴蝶的总分
    score = handleButterflySet(...);
  } else if (isScaleByCount) {
    // 显示平均每张的得分
    const totalScore = handleScaleByCount(...);
    score = Math.floor(totalScore / matchingCards.length);
  } else {
    // 正常计算
    score = calculateCardScore(...);
  }

  this.setData({ cardScore: score });
}
```

## 总结

这是一个**用户体验优化**:

- ❌ **修改前**: 显示总分,Leader 和非 Leader 卡显示不一致
- ✅ **修改后**: 显示平均值,所有卡显示一致,更直观

**设计原则**: 卡牌详情应该显示"这张卡的贡献",而不是"所有同类卡的总和"。
