# 森林洗牌 (Forest Shuffle) 游戏逻辑汇总

⚠️ **最新更新**: 2025-12-20
本文档汇总了后端计算逻辑，包括计分规则、即时奖励、被动触发效果及特殊行动。所有逻辑均基于 `miniprogram/utils` 目录下的代码实现。

---

## 1. 计分规则 (Scoring Rules)

> 核心入口: `score/index.js` -> `calculateCardScore`
> 遍历逻辑: 所有计分均基于 `playerState.forest`，并严格正确处理了 **卡牌堆叠 (Stacking)**。堆叠中的每一张卡牌（包括被覆盖的）都会被单独计算分值（除非特定位置判定逻辑要求）。

### 1.1 基础数值类 (Basic)

| 类型 (SCORING_TYPES)           | 逻辑描述                                             | 典型卡牌                                 |
| :----------------------------- | :--------------------------------------------------- | :--------------------------------------- |
| **FLAT**                       | 固定分值。                                           | 泽龟 (5 分), 苍蝇 (1 分)                 |
| **PER_TAG**                    | 每张拥有指定 Tag 的卡牌得 X 分。                     | 通用树木计分, 树蕨 (每张两栖动物得 6 分) |
| **PER_SPECIES** / **PER_NAME** | 每张指定名称的卡牌得 X 分。                          | 树蛙 (每张蚊子得 5 分)                   |
| **PER_DIFFERENT_TAG**          | 【已弃用，建议使用 SET_COLLECTION 或 BUTTERFLY_SET】 | (原蝴蝶逻辑)                             |
| **PER_DIFFERENT_SPECIES**      | 统计全场物种多样性 (不同名称数量) 得分。             | 多样性加分卡                             |
| **PER_TAG_OR**                 | 每张拥有 Tag A 或 Tag B 的卡牌得 X 分。              | 马鹿 (树/植 +1)                          |
| **PER_NAME_OR**                | 每张拥有 Name A 或 Name B 的卡牌得 X 分。            | 欧洲野牛 (橡/榉 +X)                      |

### 1.2 位置判定类 (Position)

> ⚠️ **注意**: 所有位置判定均已修复，能正确识别堆叠在下方的卡牌所归属的树/灌木。

| 类型                          | 逻辑描述                                                                  | 典型卡牌             |
| :---------------------------- | :------------------------------------------------------------------------ | :------------------- |
| **POSITION_ON_CARD**          | 卡牌依附于指定名称的树木上时得分。                                        | 苍头燕雀 (山毛榉 +5) |
| **POSITION_ON_SHRUB**         | 卡牌依附于 Tag="灌木" 的卡牌上时得分。                                    | 夜莺                 |
| **POSITION_ON_TREE_OR_SHRUB** | 依附于 树 或 灌木 上时得分。                                              | 欧洲林鼬             |
| **CONDITION_ATTACHED**        | (别名 PER_CARD_ON_TREE) 计算连接到自身的卡牌总数 (含堆叠) \* X。          | 银杉 (Silver Fir)    |
| **CONDITION_BELOW**           | (别名 PER_CARD_UNDER_TREE) 计算全场所有位于底部的卡牌总数 (含堆叠) \* X。 | 红褐林蚁             |
| **CONDITION_TREE_FULL**       | (别名 PER_FULL_TREE) 计算全场四面全满的树木数量 \* X。                    | 石貂                 |
| **PER_STACKED_CARD**          | 计算自身所在堆叠槽位中，位于自身下方的卡牌数量 \* X。                     | 大蟾蜍 (+5)          |

### 1.3 条件与阈值类 (Condition)

| 类型                   | 逻辑描述                                          | 典型卡牌                 |
| :--------------------- | :------------------------------------------------ | :----------------------- |
| **THRESHOLD**          | 若拥有指定 Tag 的卡牌总数 >= T，得固定分。        | 苔藓 (树>=10 得 10 分)   |
| **CONDITION_ON_COUNT** | 若拥有指定 Name/Tag 的卡牌总数 >= Min，得固定分。 | 山毛榉                   |
| **CONDITION_HAS_NAME** | 若拥至少 1 张指定名称的卡牌。                     | 猞猁 (有西方狍 -> 10 分) |
| **CONDITION_WITH_BAT** | 若所在的树上（任意槽位）有蝙蝠。                  | 欧洲睡鼠                 |
| **DIFFERENT_BATS**     | 若拥有 N 种不同的蝙蝠。                           | 蝙蝠类                   |

### 1.4 集合与特殊类 (Collection & Special)

| 类型                    | 逻辑描述                                                                                                 | 细节                       |
| :---------------------- | :------------------------------------------------------------------------------------------------------- | :------------------------- |
| **SET_COLLECTION**      | 收集 Tag 相同的不同名称卡牌，数量达标得分。                                                              |                            |
| **COLLECT_ALL_TREES**   | 集齐 8 种名字不同的树木。                                                                                | 野草莓                     |
| **BUTTERFLY_SET**       | **蝴蝶组计分** (贪婪算法)。<br>统计所有蝴蝶，按不同名字尽可能多地分出 Set。<br>得分 = ∑(Set 大小 \* 1)。 | 所有的蝴蝶卡牌             |
| **SCALE_BY_COUNT**      | **同名循环计分**。<br>基于同名卡牌数量查表。支持循环 (Modulo)。<br>例如 7 张一组，第 8 张算第二组。      | 萤火虫, 欧洲七叶树, 火蛾螈 |
| **GET_POINTS_BY_COLOR** | 统计拥有与自身树木符号颜色匹配的卡牌数量。                                                               | 西方狍                     |
| **MAJORITY**            | 与其他玩家对比，拥有最多某类卡牌者得分。                                                                 | 椴树                       |
| **CAVE_COUNT**          | 洞穴卡牌数量 \* X。                                                                                      | 胡兀鹫                     |

---

## 2. 奖励系统 (Rewards)

> 核心入口: `reward.js`
> 分为 **Bonus** (需支付同色卡) 和 **Effect** (直接触发)。

### 2.1 基础奖励 (REWARD_TYPES)

- **DRAW**: 摸牌 (Count)。
- **EXTRA_TURN**: 获得额外回合。
- **DRAW_AND_TURN**: 摸牌 + 额外回合 (棕熊 Bonus)。
- **PLAY_FREE**: 免费打出特定类型的牌 (Tags 限制)。如果 `isInfinite` 为 true (如蚊子打蝙蝠)，则该次行动不限数量。
- **DRAW_PER_EXISTING**: 基于场上某类卡牌数量摸牌 (赤狐)。
- **CONDITION_EXTRATURN**: 满足条件获得额外回合。

### 2.2 触发式被动 (Trigger Effects)

> 当玩家打出一张牌时，自动检查全场 _其他_ 卡牌是否触发。

- **TRIGGER_ON_PLAY_TAG_DRAW**: 当打出 Tag X 的牌时，摸牌。(鸡油菌)
- **TRIGGER_ON_PLAY_POSITION**: 当打出牌到 Position Y (如 Top) 时，摸牌。(牛肝菌)

---

## 3. 特殊行动 (Special Actions)

状态机模式 (`actionMode`)，由前端 `game.js` 和后端 `specialAction.js` 配合执行。

| 行动代码                      | 描述               | 逻辑                                               |
| :---------------------------- | :----------------- | :------------------------------------------------- |
| **ACTION_RACCOON**            | **浣熊**: 换牌     | 选 N 张手牌放入洞穴 -> 摸 N 张牌。                 |
| **ACTION_BEAR**               | **棕熊**: 清空地   | 将当前空地所有牌移入洞穴。                         |
| **ACTION_MOLE**               | **鼹鼠**: 连打     | 支付费用打出任意数量牌。                           |
| **ACTION_PICK_FROM_CLEARING** | **欧洲野猫**: 捡牌 | 选一张空地牌放入洞穴。                             |
| **ACTION_REMOVE_CLEARING**    | **雌性野猪**: 重置 | 移除空地所有牌 (移出游戏)。                        |
| **ACTION_CLEARING_TO_CAVE**   | **蜂巢**: 采蜜     | 将空地符合条件的牌 (树/植) 全部放入洞穴。          |
| **ACTION_PLAY_SAPLINGS**      | **水田鼠**: 树苗   | 打出牌作为树苗 (Tag=Tree, Name=Sapling)。          |
| **ACTION_TUCK_HAND_CARD**     | **大蟾蜍**: 吞噬   | 将 1 张手牌塞入大蟾蜍下方 (转换大蟾蜍为堆叠模式)。 |

---

## 4. 辅助系统说明

### 4.1 堆叠 (Stacking) 处理

- **数据结构**: 插槽对象 (`slot`) 可能包含 `list: []`。
  - 如果 `list` 存在且 length > 0，则 `list` 包含 **该插槽内所有卡牌** (包括当前显示的这张)。
  - 显示逻辑: 取 `list` 的最后一张作为显示。
  - 遍历逻辑: 必须只遍历 `list` (避免与 `slot` 本身双重计数)。已在 `helpers.js` 中修复。
  - 位置判定: 堆叠在下方的卡牌，其物理位置属性 (`side`) 和父节点 (`group.center`) 与顶层卡一致。已在 `position.js` 中修复查找逻辑。

### 4.2 颜色匹配 (Color Match)

- 逻辑 `colorMatcher.js`: 检查支付的卡牌 (`paymentCards`) 的颜色是否与主牌 (`card`) 的费用颜色 (`cost`) 匹配。
- 仅用于触发 **Bonus**。
