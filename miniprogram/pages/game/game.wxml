<view class="game-container">
   <view class="loading-mask" wx:if="{{!playerStates}}">
      <text>Ê≠£Âú®ËøõÂÖ•Ê£ÆÊûó...</text>
   </view>
   <block wx:else>
      <!-- È°∂ÈÉ®Áé©ÂÆ∂ÂàóË°® -->
      <scroll-view class="players-bar" scroll-x enable-flex>
         <block wx:for="{{players}}" wx:key="index">
            <view class="player-slot {{item.isEmpty ? 'is-empty' : ''}} {{item.openId === selectedPlayerOpenId ? 'selected' : ''}}" bindtap="onPlayerTap" data-openid="{{item.openId}}">
               <block wx:if="{{!item.isEmpty}}">
                  <image class="p-avatar" src="{{item.avatarUrl || '/images/default_avatar.png'}}" mode="aspectFill" />
                  <view class="p-info">
                     <view class="p-name">{{item.nickName}}</view>
                     <view class="p-stats">
                        <text class="stat-item">üÉè{{item.handCount}}</text>
                        <text class="stat-item">üèÜ{{item.score}}</text>
                     </view>
                  </view>
               </block>
               <block wx:else>
                  <view class="empty-seat">+</view>
               </block>
            </view>
         </block>
      </scroll-view>
      <!-- ‰∏≠Èó¥ÔºöÁâåÊ°åÂå∫Âüü (Board) -->
      <view class="game-board">
         <!-- Á©∫Âú∞ (Re-styled as Hand-like) -->
         <!-- Á©∫Âú∞ Header with Actions -->
         <view style="display: flex; justify-content: space-between; align-items: center; padding: 0 10rpx;">
            <view style="display: flex; align-items: center; gap: 16rpx;">
               <view class="area-label" style="margin-bottom:0; padding-right: 0;">
                  Á©∫Âú∞ ({{clearing.length || 0}}/10)
               </view>
               <!-- 1. ÁªìÊùüÔºöÊîπ‰∏∫Á∫¢Ëâ≤ÊñáÂ≠óÊ†∑ÂºèÔºåÊîæÂú®ÊñáÊ°àÂè≥Ëæπ -->
               <view class="end-turn-text" bindtap="onEndTurn" wx:if="{{isMyTurn}}">ÁªìÊùü</view>
            </view>
            <view class="action-bar-inline" wx:if="{{isMyTurn}}" style="display:flex; gap:12rpx;">
               <!-- 2. ÊãøÂèñÔºö‰ªéÁ©∫Âú∞ÊãøÂèñ‰∏ÄÂº†Áâå -->
               <button size="mini" class="game-btn draw-btn" bindtap="onConfirmTake" disabled="{{selectedClearingIdx === -1 && selectedClearingIdx !== -2}}" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  ‚úãÊãøÂèñ
               </button>
               <!-- 3. Âá∫ÁâåÔºöÁªü‰∏ÄÊåâÈíÆÔºàÂåÖÂê´Âá∫Ê†ë/ÈôÑÂ±ûÔºâ -->
               <button size="mini" class="game-btn {{selectedSlot && selectedSlot.isValid ? 'valid-play-btn' : ''}}" bindtap="onConfirmPlay" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  ‚úÖÊâìÂá∫
               </button>
               <!-- 4. Ê†ëËãó -->
               <button size="mini" class="game-btn secondary sapling-btn" bindtap="onPlaySapling" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  üå±Ê†ëËãó
               </button>
            </view>
         </view>
         <!-- Á©∫Âú∞Âå∫ÂüüÔºöÁâåÂ∫ìÂõ∫ÂÆö + Á©∫Âú∞Âç°ÁâáÂèØÊªöÂä® -->
         <view style="display:flex; gap:16rpx; align-items:flex-start;">
            <!-- P1: Âõ∫ÂÆöÁöÑÁâåÂ∫ìÂÆπÂô® (Áî®‰∫éÂØπÈΩê) -->
            <view style="display:flex; align-items:flex-end; padding: 40rpx 0 12rpx 0rpx; flex-shrink:0;">
               <view class="hand-card {{selectedClearingIdx === -2 ? 'selected' : ''}}" bindtap="onDrawCard" style="background:#8e44ad; color:white; border:none; position: relative; overflow: hidden; margin:0;">
                  <block wx:if="{{deckVisual && deckVisual.bgImg}}">
                     <view class="card-sprite-native" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; background-position: {{deckVisual.bgPosition}}; pointer-events: none;"></view>
                     <view class="card-body" style="background:transparent; color:white; z-index:1; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <view style="font-size:32rpx; font-weight:bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           ÁâåÂ∫ì
                        </view>
                        <view style="font-size:24rpx; margin-top:10rpx; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           {{deck.length || 0}}
                        </view>
                        <view style="font-size:20rpx; margin-top:8rpx; opacity:0.9; font-weight:bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           ÂõûÂêà {{currentTurn || 1}}
                        </view>
                     </view>
                  </block>
                  <block wx:else>
                     <view class="card-body" style="background:#27ae60; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <view style="font-size:64rpx;">üå±</view>
                        <view style="font-size:32rpx; font-weight:bold;">ÁâåÂ∫ì</view>
                        <view style="font-size:24rpx;">{{deck.length || 0}}</view>
                        <view style="font-size:20rpx; margin-top:8rpx; opacity:0.9; font-weight:bold;">
                           ÂõûÂêà {{currentTurn || 1}}
                        </view>
                     </view>
                  </block>
               </view>
            </view>
            <!-- P2: ÂèØÊªöÂä®ÁöÑÁ©∫Âú∞Âç°ÁâáÂå∫Âüü -->
            <scroll-view class="clearing-scroll" scroll-x enable-flex>
               <view class="clearing-row">
                  <!-- Clearing Cards -->
                  <block wx:for="{{clearing}}" wx:key="uid">
                     <view class="hand-card clearing-card {{index === selectedClearingIdx ? 'selected' : ''}}" bindtap="onClearingCardTap" bindlongpress="onShowDetail" data-idx="{{index}}" data-type="clearing">
                        <block wx:if="{{item.bgImg}}">
                           <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                        </block>
                        <block wx:else>
                           <view class="card-header" style="background-color: {{item.color || '#4caf50'}}">
                              <text class="card-name">{{item.name}}</text>
                              <view class="card-cost-badge" wx:if="{{item.cost !== undefined}}">
                                 {{item.cost}}
                              </view>
                           </view>
                           <view class="card-body">
                              <text class="card-type">{{item.type}}</text>
                           </view>
                        </block>
                     </view>
                  </block>
                  <!-- Limited Placeholders (Max 10 total clearing) -->
                  <block wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">
                     <view class="hand-card placeholder" wx:if="{{index >= (clearing.length || 0)}}">
                        <view class="card-body" style="background: transparent;">+</view>
                     </view>
                  </block>
               </view>
            </scroll-view>
         </view>
         <!-- Logs Modal Removed -->
         <!-- Êìç‰ΩúÊåâÈíÆÂå∫ (Moved Here) -->
         <!-- Êìç‰ΩúÊåâÈíÆÂå∫ (Placed immediately after Clearing) -->
         <!-- Áé©ÂÆ∂Ê£ÆÊûóÂå∫Âüü -->
         <view class="forest-area">
            <view class="area-label" style="display:flex; justify-content:space-between; width:100%; padding-right:20rpx; box-sizing:border-box;">
               <text>{{viewingPlayerNick}}ÁöÑÊ£ÆÊûó {{!isViewingSelf ? '(‰ªÖÊü•Áúã)' : ''}}</text>
               <view class="buff-btn" bindtap="onShowBuffs" wx:if="{{isViewingSelf}}">‚ú®Buff</view>
            </view>
            <scroll-view class="forest-scroll" scroll-x enable-flex>
               <block wx:for="{{myForest}}" wx:key="_id">
                  <view class="tree-group {{targetTreeId === item._id ? 'target-active' : ''}}">
                     <!-- Center: Tree -->
                     <view class="tree-center" bindlongpress="onShowDetail" data-cardid="{{item.center.id}}">
                        <block wx:if="{{item.center.bgImg}}">
                           <view class="card-sprite-native {{item.center.cssClass}}" style="background-image: url('{{item.center.bgImg}}'); background-size: {{item.center.bgSize}}; {{item.center.bgPosition ? 'background-position:' + item.center.bgPosition : ''}}"></view>
                        </block>
                        <view wx:else class="small-card forest-fallback">
                           {{item.center.name || 'Tree'}}
                        </view>
                     </view>
                     <!-- Slots -->
                     <!-- Top -->
                     <view class="slot-pos slot-top {{selectedSlot.treeId === item._id && selectedSlot.side === 'top' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="top" data-cardid="{{item.slots.top.id}}">
                        <view class="slot-card {{!item.slots.top ? 'empty' : ''}}">
                           <view class="card-sprite-native slot-crop {{item.slots.top.cssClass}}" style="background-image: url('{{item.slots.top.bgImg}}'); background-size: {{item.slots.top.bgSize}}"></view>
                        </view>
                     </view>
                     <!-- Bottom -->
                     <view class="slot-pos slot-bottom {{selectedSlot.treeId === item._id && selectedSlot.side === 'bottom' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="bottom" data-cardid="{{item.slots.bottom.id}}">
                        <view class="slot-card {{!item.slots.bottom ? 'empty' : ''}}">
                           <view class="card-sprite-native slot-crop {{item.slots.bottom.cssClass}}" style="background-image: url('{{item.slots.bottom.bgImg}}'); background-size: {{item.slots.bottom.bgSize}}"></view>
                        </view>
                     </view>
                     <!-- Left -->
                     <view class="slot-pos slot-left {{selectedSlot.treeId === item._id && selectedSlot.side === 'left' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="left" data-cardid="{{item.slots.left.id}}">
                        <view class="slot-card h-crop {{!item.slots.left ? 'empty' : ''}}">
                           <view class="card-sprite-native slot-crop {{item.slots.left.cssClass}}" style="background-image: url('{{item.slots.left.bgImg}}'); background-size: {{item.slots.left.bgSize}}"></view>
                        </view>
                     </view>
                     <!-- Right -->
                     <view class="slot-pos slot-right {{selectedSlot.treeId === item._id && selectedSlot.side === 'right' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="right" data-cardid="{{item.slots.right.id}}">
                        <view class="slot-card h-crop {{!item.slots.right ? 'empty' : ''}}">
                           <view class="card-sprite-native slot-crop {{item.slots.right.cssClass}}" style="background-image: url('{{item.slots.right.bgImg}}'); background-size: {{item.slots.right.bgSize}}"></view>
                        </view>
                     </view>
                  </view>
               </block>
               <!-- Âç†‰ΩçÁ¨¶ÊèêÁ§∫ -->
               <view class="forest-card placeholder" wx:if="{{myForest.length === 0}}">
                  <text>ÊöÇÊó†Ê†ëÊú®</text>
               </view>
            </scroll-view>
         </view>
      </view>
      <!-- ÊäΩÂç°Â±ïÁ§∫ÈÅÆÁΩ©/ÊÇ¨ÊµÆÂ±Ç -->
      <view class="preview-overlay" wx:if="{{drawingCard}}">
         <view class="preview-card-container">
            <view class="preview-card">
               <block wx:if="{{drawingCard.bgImg}}">
                  <view class="card-sprite-native {{drawingCard.cssClass}}" style="background-image: url('{{drawingCard.bgImg}}'); background-size: {{drawingCard.bgSize}}"></view>
               </block>
               <block wx:else>
                  <view class="fallback-card">{{drawingCard.name}}</view>
               </block>
            </view>
            <view class="preview-tip">Êë∏Âà∞‰∫ÜËøôÂº†Áâå</view>
         </view>
      </view>
      <!-- Turn Summary Modal (Overlay) -->
      <view class="summary-modal-mask" wx:if="{{showTurnSummary && turnSummaryData}}" bindtap="onCloseSummary">
         <view class="summary-panel" catchtap="noop">
            <view class="summary-header">
               <image class="p-avatar-small" src="{{turnSummaryData.playerAvatar || '/images/default_avatar.png'}}" />
               <text class="summary-title">{{turnSummaryData.playerNick}} ÊâìÂá∫‰∫ÜÔºö</text>
            </view>
            <view class="summary-body">
               <!-- Played Card -->
               <view class="summary-section">
                  <text class="section-label">ÊâìÂá∫Áâå</text>
                  <view class="summary-card-lg">
                     <block wx:if="{{turnSummaryData.playedCard.bgImg}}">
                        <view class="card-sprite-native {{turnSummaryData.playedCard.cssClass}}" style="background-image: url('{{turnSummaryData.playedCard.bgImg}}'); background-size: {{turnSummaryData.playedCard.bgSize}}"></view>
                     </block>
                     <block wx:else>
                        <view class="fallback-card">{{turnSummaryData.playedCard.name}}</view>
                     </block>
                     <view class="card-name-label">{{turnSummaryData.playedCard.name}}</view>
                  </view>
               </view>
               <!-- Paid Cards (Discards) -->
               <view class="summary-section" wx:if="{{turnSummaryData.paidCards.length > 0}}">
                  <text class="section-label">ÊîØ‰ªòË¥πÁî® (ÂºÉÁâå)</text>
                  <scroll-view scroll-x enable-flex class="summary-discards-scroll">
                     <block wx:for="{{turnSummaryData.paidCards}}" wx:key="uid">
                        <view class="summary-card-sm">
                           <block wx:if="{{item.bgImg}}">
                              <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                           </block>
                           <block wx:else>
                              <view class="fallback-card-sm">{{item.name}}</view>
                           </block>
                        </view>
                     </block>
                  </scroll-view>
               </view>
            </view>
         </view>
      </view>
      <!-- Â∫ïÈÉ®ÔºöÁé©ÂÆ∂ÊâãÁâå (Hand) -->
      <view class="hand-area">
         <view class="hand-header">
            <view class="area-title">ÊâãÁâå ({{playerStates[openId].hand.length}})</view>
            <view class="instruction-tip {{instructionState}}">{{instructionText}}</view>
         </view>
         <scroll-view scroll-x class="hand-scroll" enable-flex>
            <view class="hand-grid">
               <block wx:for="{{playerStates[openId].hand}}" wx:key="uid">
                  <view class="hand-card {{item.selected ? 'selected' : ''}} {{item.uid === primarySelection ? 'primary' : ''}}" bindtap="onHandTap" bindlongpress="onShowDetail" data-uid="{{item.uid}}" data-type="hand">
                     <view class="primary-flag" wx:if="{{item.uid === primarySelection}}">‰∏ªÁâå</view>
                     <block wx:if="{{item.bgImg}}">
                        <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                     </block>
                     <block wx:else>
                        <!-- Fallback for cards without images -->
                        <view class="card-header" style="background-color: {{item.color || '#4caf50'}}">
                           <text class="card-name">{{item.name}}</text>
                           <view class="card-cost-badge" wx:if="{{item.cost !== undefined}}">
                              {{item.cost}}
                           </view>
                        </view>
                        <view class="card-body">
                           <text class="card-type">{{item.type}}</text>
                           <text class="card-tags">{{item.tags[0] || ''}}</text>
                        </view>
                        <view class="card-footer">
                           <text class="card-effect-text" wx:if="{{item.effect}}">
                              {{item.effect}}
                           </text>
                        </view>
                     </block>
                  </view>
               </block>
            </view>
         </scroll-view>
      </view>
      <card-detail card-id="{{detailCardId}}" bind:close="onCloseDetail" />
   </block>
</view>