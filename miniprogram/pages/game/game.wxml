<view class="game-container">
   <view class="loading-mask" wx:if="{{!playerStates || !openId}}">
      <text>Ê≠£Âú®ËøõÂÖ•Ê£ÆÊûó...</text>
   </view>
   <block wx:else>
      <!-- È°∂ÈÉ®Áé©ÂÆ∂ÂàóË°® -->
      <scroll-view class="players-bar" scroll-x enable-flex>
         <block wx:for="{{players}}" wx:key="index">
            <view class="player-slot {{item.isEmpty ? 'is-empty' : ''}} {{item.openId === selectedPlayerOpenId ? 'selected' : ''}} {{item.openId === (gameState.activePlayer || lastActivePlayer) ? 'is-active' : ''}}" bindtap="onPlayerTap" data-openid="{{item.openId}}">
               <block wx:if="{{!item.isEmpty}}">
                  <view class="p-avatar-wrap">
                     <image class="p-avatar" src="{{item.avatarUrl || '/images/default_avatar.png'}}" mode="aspectFill" />
                  </view>
                  <view class="p-info">
                     <view class="p-name">{{item.nickName}}</view>
                     <view class="p-stats">
                        <text class="stat-item">üÉè{{item.handCount}}</text>
                        <text class="stat-item">üèÜ{{item.score}}</text>
                     </view>
                  </view>
               </block>
               <block wx:else>
                  <view class="empty-seat">+</view>
               </block>
            </view>
         </block>
      </scroll-view>
      <!-- ‰∏≠Èó¥ÔºöÁâåÊ°åÂå∫Âüü (Board) -->
      <view class="game-board">
         <!-- Á©∫Âú∞ Header with Actions -->
         <view style="display: flex; justify-content: space-between; align-items: center; padding: 0 10rpx;">
            <view style="display: flex; align-items: center; gap: 16rpx;">
               <view class="area-label" style="margin-bottom:0; padding-right: 0;">
                  Á©∫Âú∞ ({{clearing.length || 0}}/10)
               </view>
               <view class="end-turn-text" bindtap="onEndTurn" wx:if="{{isMyTurn}}">
                  {{gameState.actionMode ? 'Ë∑≥Ëøá' : 'ÁªìÊùü'}}
               </view>
            </view>
            <view class="action-bar-inline" wx:if="{{isMyTurn}}" style="display:flex; gap:12rpx;">
               <!-- Ê∞¥Áî∞Èº†Ê®°Âºè‰∏ãÈöêËóèÊãøÂèñÊåâÈíÆ -->
               <block wx:if="{{!gameState.actionMode && gameState.actionMode !== 'ACTION_PLAY_SAPLINGS'}}">
                  <button size="mini" class="game-btn draw-btn" bindtap="onConfirmTake" style="margin:0; padding:0 12rpx; font-weight:normal;">
                     ‚úãÊãøÂèñ
                  </button>
               </block>
               <!-- Ê∞¥Áî∞Èº†Ê®°Âºè‰∏ãÈöêËóèÊâìÂá∫ÊåâÈíÆ -->
               <button wx:if="{{gameState.actionMode !== 'ACTION_PLAY_SAPLINGS'}}" size="mini" class="game-btn {{instructionState === 'success' ? 'valid-play-btn' : ''}} {{gameState.actionMode && !(gameState.actionMode === 'ACTION_MOLE' || gameState.actionMode === 'ACTION_PLAY_SAPLINGS' || gameState.actionMode === 'PLAY_FREE' || gameState.actionMode === 'ACTION_RACCOON' || gameState.actionMode === 'ACTION_PICK_FROM_CLEARING' || gameState.actionMode === 'PICK_FROM_CLEARING_TO_HAND' || gameState.actionMode === 'ACTION_PICK_FROM_CLEARING_TO_CAVE') ? 'disabled' : ''}}" bindtap="onConfirmPlay" disabled="{{gameState.actionMode && !(gameState.actionMode === 'ACTION_MOLE' || gameState.actionMode === 'ACTION_PLAY_SAPLINGS' || gameState.actionMode === 'PLAY_FREE' || gameState.actionMode === 'ACTION_RACCOON' || gameState.actionMode === 'ACTION_PICK_FROM_CLEARING' || gameState.actionMode === 'PICK_FROM_CLEARING_TO_HAND' || gameState.actionMode === 'ACTION_PICK_FROM_CLEARING_TO_CAVE')}}" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  {{(gameState.actionMode === 'ACTION_PICK_FROM_CLEARING' || gameState.actionMode === 'PICK_FROM_CLEARING_TO_HAND' || gameState.actionMode === 'ACTION_PICK_FROM_CLEARING_TO_CAVE') ? '‚úÖÁ°ÆÂÆö' : '‚úÖÊâìÂá∫'}}
               </button>
               <!-- Ê∞¥Áî∞Èº†Ê®°Âºè‰∏ãÂêØÁî®Ê†ëËãóÊåâÈíÆ -->
               <button size="mini" class="game-btn secondary sapling-btn {{gameState.actionMode && gameState.actionMode !== 'ACTION_PLAY_SAPLINGS' ? 'disabled' : ''}}" bindtap="onPlaySapling" disabled="{{gameState.actionMode && gameState.actionMode !== 'ACTION_PLAY_SAPLINGS'}}" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  üå±Ê†ëËãó
               </button>
               <button size="mini" class="game-btn secondary" bindtap="onCheatAddCards" style="margin:0; padding:0 12rpx; min-width: 50rpx; font-weight:normal; background-color: #FFD700; color: #333;">
                  üîë
               </button>
            </view>
         </view>
         <!-- ÁâåÂ∫ì‰∏éÁ©∫Âú∞ -->
         <view style="display:flex; gap:16rpx; align-items:flex-start;">
            <view id="deck-card" style="display:flex; align-items:flex-end; padding: 15rpx 0 0rpx 0rpx; flex-shrink:0;">
               <view class="hand-card {{selectedClearingIdx === -2 ? 'selected' : ''}}" bindtap="onDrawCard" style="background:#8e44ad; color:white; border:none; position: relative; overflow: hidden; margin:0;">
                  <block wx:if="{{deckVisual && deckVisual.bgImg}}">
                     <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; pointer-events: none;"></view>
                     <view class="card-body" style="background:transparent; color:white; z-index:1; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <view style="font-size:32rpx; font-weight:bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           ÁâåÂ∫ì
                        </view>
                        <view style="font-size:24rpx; margin-top:10rpx; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           {{deck.length || 0}}
                        </view>
                        <view style="font-size:20rpx; margin-top:8rpx; opacity:0.9; font-weight:bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           ÂõûÂêà {{currentTurn || 1}}
                        </view>
                     </view>
                  </block>
               </view>
            </view>
            <scroll-view class="clearing-scroll" scroll-x enable-flex scroll-into-view="{{clearingScrollId}}" scroll-left="{{clearingScrollLeft}}" scroll-with-animation>
               <view class="clearing-row">
                  <block wx:for="{{clearing}}" wx:key="uid">
                     <view id="clearing-{{index}}" class="hand-card clearing-card {{index === selectedClearingIdx ? 'selected' : ''}}" bindtap="onClearingCardTap" bindlongpress="onShowDetail" data-idx="{{index}}" data-type="clearing">
                        <view wx:if="{{item.bgImg}}" class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                        <view wx:else class="card-header" style="background-color: {{item.color || '#4caf50'}}">
                           <text class="card-name">{{item.name}}</text>
                        </view>
                     </view>
                  </block>
                  <block wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">
                     <view class="hand-card placeholder" wx:if="{{index >= (clearing.length || 0)}}">
                        <view class="card-body" style="background: transparent;">+</view>
                     </view>
                  </block>
                  <!-- ÊªöÂä®ÈîöÁÇπ -->
                  <view id="clearing-end-anchor" style="width: 1rpx; height: 1rpx; flex-shrink: 0;"></view>
               </view>
            </scroll-view>
         </view>
         <!-- Ê£ÆÊûóÂå∫Âüü -->
         <view class="forest-area">
            <view class="area-label" style="display:flex; justify-content:space-between; width:100%; padding-right:20rpx; box-sizing:border-box;">
               <text>{{viewingPlayerNick}}ÁöÑÊ£ÆÊûó {{!isViewingSelf ? '(‰ªÖÊü•Áúã)' : ''}}</text>
               <view style="display: flex; align-items: center;">
                  <view class="cave-info" style="margin-right: 16rpx; display: flex; align-items: center; color: #f0e6d2; font-size: 24rpx; background: rgba(80, 60, 40, 0.6); padding: 6rpx 16rpx; border-radius: 20rpx; border: 1rpx solid rgba(255,255,255,0.2);">
                     ‚õ∞Ô∏è Ê¥ûÁ©¥: {{playerStates[selectedPlayerOpenId || openId].cave.length || 0}}
                  </view>
                  <view class="buff-btn" bindtap="onShowBuffs" wx:if="{{isViewingSelf}}">
                     ‚ú®Buff
                  </view>
               </view>
            </view>
            <scroll-view class="forest-scroll" scroll-y enable-flex>
               <view class="forest-grid">
                  <block wx:for="{{myForest}}" wx:key="_id">
                     <view class="tree-group">
                        <view class="tree-center" bindlongpress="onShowDetail" data-cardid="{{item.center.id}}" data-treeid="{{item._id}}">
                           <view wx:if="{{item.center.bgImg}}" class="card-sprite-native {{item.center.cssClass}}" style="background-image: url('{{item.center.bgImg}}'); background-size: {{item.center.bgSize}}; {{item.center.bgPosition ? 'background-position:' + item.center.bgPosition : ''}}"></view>
                           <view wx:else class="small-card forest-fallback">
                              {{item.center.name || 'Tree'}}
                           </view>
                        </view>
                        <!-- ÊßΩ‰ΩçÊ∏≤ÊüìÔºö‰ΩøÁî®‰Ω†ÂéüÂßãÁöÑËØ¶ÁªÜÂ∏ÉÂ±Ä -->
                        <view class="slot-pos slot-top {{selectedSlot.treeId === item._id && selectedSlot.side === 'top' ? 'selected' : ''}} {{selectedSlot.treeId === item._id && selectedSlot.side === 'top' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="top" data-cardid="{{item.slots.top.id}}">
                           <view class="slot-card {{!item.slots.top ? 'empty' : ''}}">
                              <view wx:if="{{item.slots.top}}" class="card-sprite-native slot-crop {{item.slots.top.cssClass}}" style="background-image: url('{{item.slots.top.bgImg}}'); background-size: {{item.slots.top.bgSize}}"></view>
                           </view>
                           <view class="stack-badge" wx:if="{{item.slots.top.max}}" catchtap="onStackTap" data-treeid="{{item._id}}" data-side="top">
                              {{item.slots.top.list.length}}
                           </view>
                        </view>
                        <view class="slot-pos slot-bottom {{selectedSlot.treeId === item._id && selectedSlot.side === 'bottom' ? 'selected' : ''}} {{selectedSlot.treeId === item._id && selectedSlot.side === 'bottom' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="bottom" data-cardid="{{item.slots.bottom.id}}">
                           <view class="slot-card {{!item.slots.bottom ? 'empty' : ''}}">
                              <view wx:if="{{item.slots.bottom}}" class="card-sprite-native slot-crop {{item.slots.bottom.cssClass}}" style="background-image: url('{{item.slots.bottom.bgImg}}'); background-size: {{item.slots.bottom.bgSize}}"></view>
                           </view>
                           <view class="stack-badge" wx:if="{{item.slots.bottom.max}}" catchtap="onStackTap" data-treeid="{{item._id}}" data-side="bottom">
                              {{item.slots.bottom.list.length}}
                           </view>
                        </view>
                        <view class="slot-pos slot-left {{selectedSlot.treeId === item._id && selectedSlot.side === 'left' ? 'selected' : ''}} {{selectedSlot.treeId === item._id && selectedSlot.side === 'left' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="left" data-cardid="{{item.slots.left.id}}">
                           <view class="slot-card h-crop {{!item.slots.left ? 'empty' : ''}}">
                              <view wx:if="{{item.slots.left}}" class="card-sprite-native slot-crop {{item.slots.left.cssClass}}" style="background-image: url('{{item.slots.left.bgImg}}'); background-size: {{item.slots.left.bgSize}}"></view>
                           </view>
                           <view class="stack-badge" wx:if="{{item.slots.left.max}}" catchtap="onStackTap" data-treeid="{{item._id}}" data-side="left">
                              {{item.slots.left.list.length}}
                           </view>
                        </view>
                        <view class="slot-pos slot-right {{selectedSlot.treeId === item._id && selectedSlot.side === 'right' ? 'selected' : ''}} {{selectedSlot.treeId === item._id && selectedSlot.side === 'right' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="right" data-cardid="{{item.slots.right.id}}">
                           <view class="slot-card h-crop {{!item.slots.right ? 'empty' : ''}}">
                              <view wx:if="{{item.slots.right}}" class="card-sprite-native slot-crop {{item.slots.right.cssClass}}" style="background-image: url('{{item.slots.right.bgImg}}'); background-size: {{item.slots.right.bgSize}}"></view>
                           </view>
                           <view class="stack-badge" wx:if="{{item.slots.right.max}}" catchtap="onStackTap" data-treeid="{{item._id}}" data-side="right">
                              {{item.slots.right.list.length}}
                           </view>
                        </view>
                     </view>
                  </block>
                  <!-- Ê£ÆÊûóÂç†‰ΩçÔºöÂ¶ÇÊûúÊ≤°ÊúâÊ†ëÔºåËá≥Â∞ëÊòæÁ§∫‰∏Ä‰∏™ÂºïÂØºÊ°Ü -->
                  <view class="tree-group placeholder" wx:if="{{myForest.length === 0}}" style="align-self: center; margin-top: 40rpx;">
                     <view class="tree-center" style="background: rgba(255,255,255,0.05); border: 2rpx dashed rgba(255,255,255,0.2); box-shadow:none; display: flex; align-items: center; justify-content: center;">
                        <view style="color:rgba(255,255,255,0.2); font-size:40rpx;">+</view>
                     </view>
                  </view>
               </view>
            </scroll-view>
         </view>
      </view>
      <!-- ÂÖ®Â±ÄÂä®‰ΩúÂ±ïÁ§∫Â±Ç (Action Event Display) -->
      <view class="preview-overlay" wx:if="{{currentEvent}}">
         <view class="preview-card-container">
            <!-- Âú∫ÊôØ1: Áé©ÂÆ∂Âá∫Áâå -->
            <block wx:if="{{currentEvent.type === 'PLAY_CARD'}}">
               <view class="event-header">
                  <image class="p-avatar-small" src="{{currentEvent.playerAvatar || '/images/default_avatar.png'}}" />
                  <text class="event-title">{{currentEvent.playerNick}} ÊâìÂá∫‰∫Ü</text>
               </view>
               <view class="main-card-display">
                  <view class="primary-flag">‰∏ªÁâå</view>
                  <view class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}; background-position: {{currentEvent.mainCard.bgPosition || '0 0'}}"></view>
               </view>
               <view class="sub-cards-label" wx:if="{{currentEvent.subCards.length > 0}}">
                  ÊîØ‰ªòË¥πÁî®Ôºö
               </view>
               <view class="sub-cards-display" wx:if="{{currentEvent.subCards.length > 0}}">
                  <view wx:for="{{currentEvent.subCards}}" wx:key="uid" class="event-sub-card">
                     <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                  </view>
               </view>
               <!-- Â•ñÂä±ÂíåÊïàÊûú‰ø°ÊÅØÂ±ïÁ§∫ -->
               <view class="reward-info" wx:if="{{currentEvent.bonusText || currentEvent.effectText || (currentEvent.triggers && currentEvent.triggers.length > 0)}}" style="margin-top: 20rpx; padding: 16rpx 24rpx; background: rgba(255, 215, 0, 0.15); border-radius: 12rpx; border: 2rpx solid rgba(255, 215, 0, 0.3);">
                  <!-- Â•ñÂä±‰ºòÂÖàÊòæÁ§∫,Áî®ÁªøËâ≤ -->
                  <view wx:if="{{currentEvent.bonusText}}" style="color: #90EE90; font-size: 26rpx; margin-bottom: 8rpx; display: flex; align-items: center;">
                     <text style="margin-right: 8rpx;">üéÅ</text>
                     <text>Â•ñÂä±: {{currentEvent.bonusText}}</text>
                  </view>
                  <!-- ÊïàÊûúÁî®ËìùËâ≤ -->
                  <view wx:if="{{currentEvent.effectText}}" style="color: #87CEEB; font-size: 26rpx; margin-bottom: 8rpx; display: flex; align-items: center;">
                     <text style="margin-right: 8rpx;">‚ú®</text>
                     <text>ÊïàÊûú: {{currentEvent.effectText}}</text>
                  </view>
                  <!-- Ëß¶ÂèëÊïàÊûúÁî®ÈáëËâ≤ -->
                  <block wx:if="{{currentEvent.triggers && currentEvent.triggers.length > 0}}">
                     <view wx:for="{{currentEvent.triggers}}" wx:key="index" style="color: #FFD700; font-size: 26rpx; margin-bottom: 8rpx; display: flex; align-items: center;">
                        <text style="margin-right: 8rpx;">‚ö°</text>
                        <text>Ëß¶Âèë„Äê{{item.cardName}}„Äë: {{item.text}}</text>
                     </view>
                  </block>
               </view>
            </block>
            <!-- Âú∫ÊôØ2: ÁâåÂ∫ìÁøªÂºÄ/Êë∏Áâå/Â•ñÂä±ÊäΩÁâå (3D Flip) -->
            <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' || currentEvent.type === 'DRAW_CARD' || currentEvent.type === 'REWARD_DRAW'}}">
               <view class="event-header">
                  <!-- ÁøªÁâåÂà∞Á©∫Âú∞‰∏çÊòæÁ§∫Áé©ÂÆ∂Â§¥ÂÉè -->
                  <image class="p-avatar-small" wx:if="{{currentEvent.type !== 'DECK_TO_CLEARING' && currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
                  <text class="event-title">
                     <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING'}}">
                        ÁøªÁâå ({{currentEvent.count}}Âº†)
                     </block>
                     <block wx:elif="{{currentEvent.type === 'REWARD_DRAW'}}">
                        {{currentEvent.playerNick}} Â•ñÂä± ({{currentEvent.count}}Âº†)
                     </block>
                     <block wx:else>{{currentEvent.playerNick}} Ê≠£Âú®Êë∏Áâå...</block>
                  </text>
               </view>
               <!-- ÁøªÁâå‰∫ã‰ª∂ÔºöÂ±ïÁ§∫ÊâÄÊúâÁøªÂá∫ÁöÑÂç°Áâá -->
               <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' && currentEvent.revealedCards}}">
                  <view class="reward-cards-display">
                     <view wx:for="{{currentEvent.revealedCards}}" wx:key="uid" class="reward-card-item">
                        <view class="flip-container">
                           <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
                              <!-- ÂàùÂßãÈù¢: ËÉåÈù¢ -->
                              <view class="flip-front">
                                 <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                              </view>
                              <!-- ÁøªËΩ¨Èù¢: Ê≠£Èù¢ -->
                              <view class="flip-back">
                                 <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}};"></view>
                              </view>
                           </view>
                        </view>
                     </view>
                  </view>
               </block>
               <!-- Â•ñÂä±ÊäΩÁâåÔºöÊòæÁ§∫Â§öÂº†Âç°Áâá -->
               <block wx:elif="{{currentEvent.type === 'REWARD_DRAW' && currentEvent.drawnCards}}">
                  <view class="reward-cards-display">
                     <view wx:for="{{currentEvent.drawnCards}}" wx:key="uid" class="reward-card-item">
                        <view class="flip-container">
                           <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
                              <!-- ÂàùÂßãÈù¢: ËÉåÈù¢ -->
                              <view class="flip-front">
                                 <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                              </view>
                              <!-- ÁøªËΩ¨Èù¢: Âè™ÊúâËá™Â∑±ËÉΩÁúãÂà∞Ê≠£Èù¢ -->
                              <view class="flip-back">
                                 <block wx:if="{{currentEvent.playerOpenId === openId}}">
                                    <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}};"></view>
                                 </block>
                                 <block wx:else>
                                    <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                                 </block>
                              </view>
                           </view>
                        </view>
                     </view>
                  </view>
               </block>
               <!-- ÂÖ∂‰ªñÊäΩÁâå‰∫ã‰ª∂ÔºöÂçïÂº†Âç°Áâá -->
               <block wx:else>
                  <view class="flip-container">
                     <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
                        <!-- ÂàùÂßãÈù¢ (0deg): ËÉåÈù¢ (Sapling) -->
                        <view class="flip-front">
                           <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                        </view>
                        <!-- ÁøªËΩ¨Èù¢ (180deg): ÂÜÖÂÆπ -->
                        <view class="flip-back">
                           <!-- Âè™ÊúâÁé©ÂÆ∂Ëá™Â∑±ÊàñÂÖ¨ÂºÄÁøªÁâåÊó∂ÊâçÁúãÂæóÂà∞Ê≠£Èù¢ÂÜÖÂÆπ -->
                           <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' || currentEvent.playerOpenId === openId}}">
                              <view wx:if="{{currentEvent.mainCard}}" class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}">
                                 <!-- ÂÜ¨Â≠£Âç°ÊèêÁ§∫ÈÅÆÁΩ© -->
                                 <view class="winter-overlay" wx:if="{{currentEvent.isWinterReveal}}">
                                    <view class="winter-count-badge">
                                       ÂÜ¨Â≠£Âç° {{currentEvent.winterCount}}/3
                                    </view>
                                 </view>
                              </view>
                              <view wx:else class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                           </block>
                           <block wx:else>
                              <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                           </block>
                        </view>
                     </view>
                  </view>
               </block>
            </block>
            <!-- Âú∫ÊôØ3: Áé©ÂÆ∂ÊãøÂèñÂç°Áâá -->
            <block wx:if="{{currentEvent.type === 'TAKE_CARD'}}">
               <view class="event-header">
                  <image class="p-avatar-small" src="{{currentEvent.playerAvatar || '/images/default_avatar.png'}}" />
                  <text class="event-title">{{currentEvent.playerNick}} ÊãøËµ∞‰∫Ü</text>
               </view>
               <view class="main-card-display">
                  <view class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}"></view>
               </view>
            </block>
            <!-- Âú∫ÊôØ4: È¢ùÂ§ñÂõûÂêà -->
            <block wx:if="{{currentEvent.type === 'EXTRA_TURN'}}">
               <view class="event-header">
                  <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
                  <view class="p-avatar-small default-avatar" wx:else></view>
                  <text class="event-title">
                     {{currentEvent.icon || 'üéâ'}} {{currentEvent.playerNick}} {{currentEvent.message}}
                  </text>
               </view>
            </block>
            <!-- Âú∫ÊôØ5: ÊîæÂÖ•Ê¥ûÁ©¥ (Êµ£ÁÜäË°åÂä®) -->
            <block wx:if="{{currentEvent.type === 'CAVE_CARDS'}}">
               <view class="event-header">
                  <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
                  <view class="p-avatar-small default-avatar" wx:else></view>
                  <text class="event-title">
                     {{currentEvent.playerNick}} Â∞Ü {{currentEvent.count}} Âº†ÁâåÊîæÂÖ•Ê¥ûÁ©¥
                  </text>
               </view>
               <view class="reward-cards-display">
                  <view wx:for="{{currentEvent.cavedCards}}" wx:key="uid" class="reward-card-item">
                     <view class="hand-card" style="margin: 0;">
                        <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                     </view>
                  </view>
               </view>
            </block>
            <!-- Âú∫ÊôØ6: ÂõûÂêàÂàáÊç¢ -->
            <block wx:if="{{currentEvent.type === 'TURN_CHANGE'}}">
               <view class="event-header">
                  <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
                  <view class="p-avatar-small default-avatar" wx:else></view>
                  <text class="event-title" style="{{currentEvent.isMyTurn ? 'color: #90EE90; font-weight: bold;' : ''}}">
                     {{currentEvent.isMyTurn ? 'üéØ ËΩÆÂà∞‰Ω†‰∫Ü!' : currentEvent.playerNick + ' ÁöÑÂõûÂêà'}}
                  </text>
               </view>
            </block>
            <!-- Âú∫ÊôØ7: ÈÄöÁü• -->
            <block wx:if="{{currentEvent.type === 'NOTIFICATION'}}">
               <view class="event-header">
                  <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
                  <text class="event-title">
                     {{currentEvent.icon || 'üîî'}} {{currentEvent.playerNick ? currentEvent.playerNick + ' ' : ''}}{{currentEvent.message}}
                  </text>
               </view>
            </block>
         </view>
      </view>
      <!-- Â∫ïÈÉ®ÊâãÁâå -->
      <view class="spectator-bar" wx:if="{{isSpectator}}" style="width:100%; height:120rpx; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; position:fixed; bottom:0; padding-bottom:env(safe-area-inset-bottom);">
         <text style="color:white; font-size:32rpx;">üëÄ ÂΩìÂâç‰∏∫ÊóÅËßÇÊ®°Âºè</text>
      </view>
      <view class="hand-area" wx:else>
         <view class="hand-header" style="align-items: flex-start;">
            <view class="area-title" style="flex-shrink: 0; margin-top: 6rpx;">
               ÊâãÁâå ({{playerStates[openId].hand.length}})
            </view>
            <view wx:if="{{gameState.activePlayer === openId}}" class="instruction-tip {{instructionState}}" style="display:flex; flex-direction:column; align-items:flex-start; margin-left: 16rpx; padding: 4rpx 12rpx; margin-top: -36rpx;">
               <block wx:if="{{instructionLines}}">
                  <view wx:if="{{instructionLines.cost.text}}" class="{{instructionLines.cost.class}}">
                     {{instructionLines.cost.text}}
                  </view>
                  <view wx:if="{{instructionLines.bonus.text}}" class="{{instructionLines.bonus.class}}" style="min-height: 32rpx;">
                     {{instructionLines.bonus.text}}
                  </view>
                  <view wx:if="{{instructionLines.effect.text}}" class="{{instructionLines.effect.class}}" style="min-height: 32rpx;">
                     {{instructionLines.effect.text}}
                  </view>
               </block>
               <block wx:elif="{{instructionSegments && instructionSegments.length > 0}}">
                  <view>
                     <text wx:for="{{instructionSegments}}" wx:key="index" class="{{item.class}}" style="margin-right: 4rpx;">
                        {{item.text}}
                     </text>
                  </view>
               </block>
               <block wx:else>{{instructionText}}</block>
            </view>
         </view>
         <scroll-view scroll-x class="hand-scroll" enable-flex>
            <view class="hand-grid">
               <block wx:for="{{playerStates[openId].hand}}" wx:key="uid">
                  <view class="hand-card {{item.uid === primarySelection ? 'primary-selected' : (item.selected ? 'payment-selected' : '')}}" bindtap="onHandTap" bindlongpress="onShowDetail" data-uid="{{item.uid}}" data-type="hand">
                     <view wx:if="{{item.uid === primarySelection}}" class="primary-flag">‰∏ªÁâå</view>
                     <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                  </view>
               </block>
               <!-- ÊâãÁâåÂç†‰ΩçÔºöÊ®°‰ªøÁ©∫Âú∞ÈÄªËæë -->
               <block wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">
                  <view class="hand-card placeholder" wx:if="{{index >= (playerStates[openId].hand.length || 0)}}">
                     <view class="card-body" style="background: transparent;">+</view>
                  </view>
               </block>
            </view>
         </scroll-view>
      </view>
      <card-detail card-id="{{detailCardId}}" in-game="{{detailInGame}}" game-context="{{detailGameContext}}" card-data="{{detailCardData}}" active-side="{{detailActiveSide}}" bind:close="onCloseDetail" />
   </block>
   <!-- Â†ÜÂè†Âç°ÁâåÂºπÁ™ó -->
   <view class="stack-modal-mask" wx:if="{{stackModalVisible}}" bindtap="closeStackModal">
      <view class="stack-modal-content" catchtap="true" style="background:transparent; border:none; box-shadow:none; width:90%; max-height:none; align-items: center;">
         <view class="stack-modal-header" style="background:rgba(0,0,0,0.6); border-radius: 10rpx; margin-bottom: 40rpx; width: fit-content; padding: 10rpx 40rpx;">
            Â†ÜÂè†ÂàóË°® ({{stackModalCards.length}})
         </view>
         <view class="stack-list-grid" style="width: 100%; display: flex; flex-wrap: wrap; justify-content: center; align-content: center; gap: 20rpx; padding: 20rpx 0;">
            <view wx:for="{{stackModalCards}}" wx:key="uid" class="hand-card" style="margin-bottom: 0;">
               <view class="card-sprite-native {{'card-' + item.id}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}};"></view>
            </view>
         </view>
      </view>
   </view>
   <card-gallery visible="{{cheatVisible}}" bind:select="onCheatCardSelect" bind:preview="onCheatCardPreview" bind:close="closeCheatModal" />
</view>