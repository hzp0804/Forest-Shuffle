<import src="templates/player-bar.wxml" />
<import src="templates/action-bar.wxml" />
<import src="templates/clearing-scroll.wxml" />
<import src="templates/forest-area.wxml" />
<import src="templates/event-overlay.wxml" />
<import src="templates/hand-area.wxml" />
<import src="templates/stack-modal.wxml" />
<view class="game-container">
   <view class="loading-mask" wx:if="{{!playerStates || !openId}}">
      <text>正在进入森林...</text>
   </view>
   <block wx:else>
      <!-- 顶部玩家列表 -->
      <template is="player-bar" data="{{players, gameState, selectedPlayerOpenId, openId, lastActivePlayer}}" />
      <!-- 中间：牌桌区域 (Board) -->
      <view class="game-board">
         <!-- 操作按钮栏 -->
         <template is="action-bar" data="{{clearingLength: clearing.length, gameState, isMyTurn: gameState.activePlayer === openId, instructionState}}" />
         <!-- 牌库与空地 -->
         <template is="clearing-scroll" data="{{selectedClearingIdx, deckVisual, currentTurn, deckLength: deck.length, gameState, clearing, clearingScrollId, openId}}" />
         <!-- 森林区域 -->
         <template is="forest-area" data="{{players, currentForestIndex, playerStates, selectedPlayerOpenId, openId, gameState, isViewingSelf, selectedSlot, instructionState, forestScrollTop}}" />
      </view>
      <!-- 全局动作展示层 -->
      <template is="event-overlay" data="{{currentEvent, isCardFlipped, deckVisual, openId}}" />
      <!-- 底部手牌 -->
      <template is="hand-area" data="{{isSpectator, handExpanded, handLength: playerStates[openId].hand.length, openId, gameState, instructionState, instructionLines, instructionSegments, instructionText, myHand: playerStates[openId].hand, primarySelection, bonusActive: playerStates[openId].bonusActive}}" />
      <!-- 弹窗 -->
      <card-detail card-id="{{detailCardId}}" in-game="{{detailInGame}}" game-context="{{detailGameContext}}" card-data="{{detailCardData}}" active-side="{{detailActiveSide}}" bind:close="onCloseDetail" />
      <template is="stack-modal" data="{{stackModalVisible, stackModalCards}}" />
      <card-gallery visible="{{cheatVisible}}" bind:select="onCheatCardSelect" bind:preview="onCheatCardPreview" bind:close="closeCheatModal" />
   </block>
</view>