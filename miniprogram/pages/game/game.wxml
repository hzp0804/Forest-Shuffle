<view class="game-container">
  <view class="loading-mask" wx:if="{{!gameData}}">
    <text>Ê≠£Âú®ËøõÂÖ•Ê£ÆÊûó...</text>
  </view>

  <block wx:else>
    <!-- È°∂ÈÉ®Áé©ÂÆ∂ÂàóË°® -->
    <scroll-view class="players-bar" scroll-x enable-flex>
      <block wx:for="{{allPlayers}}" wx:key="index">
        <view class="player-slot {{item.isMe ? 'is-me' : ''}} {{item.isEmpty ? 'is-empty' : ''}}">
           <block wx:if="{{!item.isEmpty}}">
             <image class="p-avatar" src="{{item.avatarUrl || '/images/default_avatar.png'}}" mode="aspectFill" />
             <view class="p-info">
                <view class="p-name">{{item.nickName}}</view>
                <view class="p-stats">
                   <text class="stat-item">üÉè{{item.handCount}}</text>
                   <text class="stat-item">üèÜ{{item.score}}</text>
                </view>
             </view>
           </block>
           <block wx:else>
             <view class="empty-seat">+</view>
           </block>
        </view>
      </block>
    </scroll-view>

    <!-- ‰∏≠Èó¥ÔºöÁâåÊ°åÂå∫Âüü (Board) -->
    <view class="game-board">

       <!-- Á©∫Âú∞ (Re-styled as Hand-like) -->
       <!-- Á©∫Âú∞ Header with Actions -->
       <view style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10rpx; padding-right: 10rpx;">
           <view class="area-label" style="margin-bottom:0;">Á©∫Âú∞ ({{clearing.length || 0}}/10)</view>
           
           <view class="action-bar-inline" wx:if="{{isMyTurn}}" style="display:flex; gap:12rpx;">
              
              <!-- 2. ÊãøÂèñ -->
              <button size="mini" class="game-btn draw-btn" bindtap="onConfirmTake" disabled="{{selectedClearingIdx === -1}}" style="margin:0; padding:0 12rpx; font-weight:normal;">‚úãÊãøÂèñ</button>
              
              <!-- 3. Âá∫Áâå -->
              <block wx:if="{{selectedSlot && selectedSlot.isValid}}">
                   <button size="mini" class="game-btn valid-play-btn" bindtap="onConfirmPlay" style="margin:0; padding:0 12rpx; font-weight:normal;">‚úÖÊâìÂá∫</button>
              </block>
              <block wx:else>
                   <button size="mini" class="game-btn" bindtap="onConfirmPlay" style="margin:0; padding:0 12rpx; font-weight:normal;">üå≤Âá∫Ê†ë</button>
              </block>
              
              <!-- 4. Ê†ëËãó -->
              <button size="mini" class="game-btn secondary sapling-btn" bindtap="onPlaySapling" style="margin:0; padding:0 12rpx; font-weight:normal;">üå±Ê†ëËãó</button>
           </view>
       </view>
       <scroll-view class="clearing-scroll" scroll-x enable-flex>
           <view class="clearing-row" style="padding-top: 20rpx;">
               <!-- P1: Deck (ÁâåÂ∫ì) -->
               <view class="hand-card small-card" bindtap="onDrawCard" style="background:#8e44ad; color:white; border:none; margin-right: 16rpx;">
                   <view class="card-body" style="background:transparent; color:white;">
                       <view style="font-size:32rpx; font-weight:bold;">ÁâåÂ∫ì</view>
                       <view style="font-size:24rpx; margin-top:10rpx;">{{deckCount || 0}}</view>
                   </view>
               </view>

               <!-- P2: Clearing Cards -->
               <block wx:for="{{clearing}}" wx:key="uid">
                  <view class="hand-card clearing-card {{index === selectedClearingIdx ? 'selected' : ''}}" 
                        bindtap="onClearingCardTap" 
                        bindlongpress="onShowDetail" 
                        data-idx="{{index}}" 
                        data-type="clearing">
                     <block wx:if="{{item.img}}">
                        <view class="card-sprite-viewport">
                           <image src="{{item.img}}" class="card-sprite-img" style="{{item.spriteStyle}}" lazy-load webp="true" />
                        </view>
                     </block>
                     <block wx:else>
                        <view class="card-header" style="background-color: {{item.color || '#4caf50'}}">
                           <text class="card-name">{{item.name}}</text>
                           <view class="card-cost-badge" wx:if="{{item.cost !== undefined}}">{{item.cost}}</view>
                        </view>
                        <view class="card-body">
                           <text class="card-type">{{item.type}}</text>
                        </view>
                     </block>
                  </view>
               </block>

               <!-- P3: Limited Placeholders (Max 10 total clearing) -->
               <block wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">
                   <view class="hand-card placeholder" wx:if="{{index >= (clearing.length || 0)}}" style="opacity:0.3; border: 2rpx dashed #ccc;">
                       <view class="card-body" style="background: transparent;">+</view>
                   </view>
               </block>
           </view>
       </scroll-view>

       <!-- Êìç‰ΩúÊåâÈíÆÂå∫ (Moved Here) -->

       

       <!-- Êìç‰ΩúÊåâÈíÆÂå∫ (Placed immediately after Clearing) -->

       
       <!-- Áé©ÂÆ∂Ê£ÆÊûóÂå∫Âüü -->
       <view class="forest-area">
          <view class="area-label">Ê£ÆÊûó</view>
          <scroll-view class="forest-scroll" scroll-x enable-flex>
             <block wx:for="{{myForest}}" wx:key="_id">
                <view class="tree-group {{targetTreeId === item._id ? 'target-active' : ''}}">
                    
                    <!-- Center: Tree -->
                    <view class="tree-center">
                        <view class="sapling-tag" wx:if="{{item.center.sapling}}">Ê†ëËãó</view>
                        <block wx:if="{{item.center.img}}">
                            <view class="card-sprite-viewport">
                                <image src="{{item.center.img}}" class="card-sprite-img" style="{{item.center.spriteStyle}}" lazy-load webp="true" />
                            </view>
                        </block>
                        <view wx:else class="small-card forest-fallback">{{item.center.name || 'Tree'}}</view>
                    </view>

                    <!-- Slots -->
                    <!-- Top -->
                    <view class="slot-pos slot-top {{selectedSlot.treeId === item._id && selectedSlot.side === 'top' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" data-treeid="{{item._id}}" data-side="top">
                           <view class="slot-card {{!item.slots.top ? 'empty' : ''}}">
                              <view class="card-sprite-viewport slot-crop" wx:if="{{item.slots.top}}">
                                 <image src="{{item.slots.top.img}}" class="card-sprite-img" style="{{item.slots.top.spriteStyle}}" lazy-load />
                              </view>
                           </view>
                    </view>

                    <!-- Bottom -->
                    <view class="slot-pos slot-bottom {{selectedSlot.treeId === item._id && selectedSlot.side === 'bottom' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" data-treeid="{{item._id}}" data-side="bottom">
                           <view class="slot-card {{!item.slots.bottom ? 'empty' : ''}}">
                              <view class="card-sprite-viewport slot-crop" wx:if="{{item.slots.bottom}}">
                                 <image src="{{item.slots.bottom.img}}" class="card-sprite-img" style="{{item.slots.bottom.spriteStyle}}" lazy-load />
                              </view>
                           </view>
                    </view>

                    <!-- Left -->
                    <view class="slot-pos slot-left {{selectedSlot.treeId === item._id && selectedSlot.side === 'left' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" data-treeid="{{item._id}}" data-side="left">
                           <view class="slot-card h-crop {{!item.slots.left ? 'empty' : ''}}">
                              <view class="card-sprite-viewport slot-crop" wx:if="{{item.slots.left}}">
                                 <image src="{{item.slots.left.img}}" class="card-sprite-img" style="{{item.slots.left.spriteStyle}}" lazy-load />
                              </view>
                           </view>
                    </view>

                    <!-- Right -->
                    <view class="slot-pos slot-right {{selectedSlot.treeId === item._id && selectedSlot.side === 'right' ? (selectedSlot.isValid ? 'valid-target selected' : 'invalid-target selected') : ''}}" bindtap="onSlotTap" data-treeid="{{item._id}}" data-side="right">
                           <view class="slot-card h-crop {{!item.slots.right ? 'empty' : ''}}">
                              <view class="card-sprite-viewport slot-crop" wx:if="{{item.slots.right}}">
                                 <image src="{{item.slots.right.img}}" class="card-sprite-img" style="{{item.slots.right.spriteStyle}}" lazy-load />
                              </view>
                           </view>
                    </view>

                </view>
             </block>
             <!-- Âç†‰ΩçÁ¨¶ÊèêÁ§∫ -->
             <view class="forest-card placeholder" wx:if="{{myForest.length === 0}}">
                <text>ÊöÇÊó†Ê†ëÊú®</text>
             </view>
          </scroll-view>
       </view>
    </view>



    <!-- Card Detail Modal (Gallery Style) -->
  <view class="detail-modal-mask" wx:if="{{showDetailModal}}" bindtap="onCloseDetail">
     <view class="preview-card" catchtap="noop">
       <view class="preview-header">
         <view class="card-sprite-viewport preview">
           <image src="{{previewCard.img}}" class="card-sprite-img" style="{{previewCard.spriteStyle}}" mode="aspectFill" />
         </view>
       </view>
 
       <view class="preview-content">
         <!-- Tabs for Split Cards -->
         <view class="species-tabs" wx:if="{{previewCard.speciesDetails.length > 1}}">
           <block wx:for="{{previewCard.speciesDetails}}" wx:key="key">
             <view class="tab-item {{activeTab === index ? 'active' : ''}}" bindtap="onTabChange" data-index="{{index}}">
               {{item.displayName}}
             </view>
           </block>
         </view>
 
         <scroll-view scroll-y class="details-scroll" enable-flex>
           <block wx:for="{{previewCard.speciesDetails}}" wx:key="key">
             <view class="detail-panel" hidden="{{activeTab !== index}}">
               
               <view class="detail-header" wx:if="{{previewCard.speciesDetails.length === 1}}">
                 <text class="detail-title">{{item.displayName}}</text>
               </view>
 
               <view class="info-grid">
                 <view class="info-row" wx:if="{{item.tags && item.tags.length}}">
                   <view class="info-label">üè∑Ô∏è Ê†áÁ≠æ</view>
                   <view class="info-value">
                      <view class="tag-pill" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</view>
                   </view>
                 </view>
 
                 <view class="info-row" wx:if="{{item.nb}}">
                   <view class="info-label">üî¢ Êï∞Èáè</view>
                   <view class="info-value">{{item.nb}} Âº†</view>
                 </view>
 
                 <view class="info-row" wx:if="{{item.cost || item.cost === 0}}">
                   <view class="info-label">üí∞ Ë¥πÁî®</view>
                   <view class="info-value highlight">{{item.cost}}</view>
                 </view>
 
                 <view class="info-block" wx:if="{{item.effect}}">
                   <view class="info-label">‚ú® ÊïàÊûú</view>
                   <view class="info-value-text">{{item.effect}}</view>
                 </view>
 
                 <view class="info-block" wx:if="{{item.bonus}}">
                   <view class="info-label">üéÅ Â•ñÂä±</view>
                   <view class="info-value-text">{{item.bonus}}</view>
                 </view>
 
                 <view class="info-block" wx:if="{{item.points}}">
                   <view class="info-label">üèÜ ËÆ°ÂàÜ</view>
                   <view class="info-value-text">{{item.points}}</view>
                 </view>
               </view>
 
             </view>
           </block>
         </scroll-view>
       </view>
     </view>
  </view>

    <!-- Â∫ïÈÉ®ÔºöÁé©ÂÆ∂ÊâãÁâå (Hand) -->
    <view class="hand-area">
       <view class="hand-header">
          <view class="area-title">ÊâãÁâå ({{myHand.length}})</view>
          <view class="instruction-tip {{instructionState}}">{{instructionText}}</view>
       </view>
       <scroll-view scroll-x class="hand-scroll" enable-flex>
          <view class="hand-grid">
             <block wx:for="{{myHand}}" wx:key="uid">
             <view class="hand-card {{item.selected ? 'selected' : ''}} {{item.uid === primarySelection ? 'primary' : ''}}" bindtap="onCardTap" bindlongpress="onShowDetail" data-uid="{{item.uid}}" data-type="hand">
                   <view class="primary-flag" wx:if="{{item.uid === primarySelection}}">‰∏ªÁâå</view>
                   <block wx:if="{{item.img}}">
                      <view class="card-sprite-viewport">
                         <image src="{{item.img}}" class="card-sprite-img" style="{{item.spriteStyle}}" lazy-load webp="true" />
                      </view>
                   </block>
                   <block wx:else>
                      <!-- Fallback for cards without images -->
                      <view class="card-header" style="background-color: {{item.color || '#4caf50'}}">
                         <text class="card-name">{{item.name}}</text>
                         <view class="card-cost-badge" wx:if="{{item.cost !== undefined}}">{{item.cost}}</view>
                      </view>
                      <view class="card-body">
                         <text class="card-type">{{item.type}}</text>
                         <text class="card-tags">{{item.tags[0] || ''}}</text>
                      </view>
                      <view class="card-footer">
                         <text class="card-effect-text" wx:if="{{item.effect}}">{{item.effect}}</text>
                      </view>
                   </block>
                </view>
             </block>
          </view>
       </scroll-view>
    </view>


  </block>
</view>
