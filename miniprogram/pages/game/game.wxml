<view class="game-container">
   <view class="loading-mask" wx:if="{{!playerStates || !openId}}">
      <text>Ê≠£Âú®ËøõÂÖ•Ê£ÆÊûó...</text>
   </view>
   <block wx:else>
      <!-- È°∂ÈÉ®Áé©ÂÆ∂ÂàóË°® -->
      <scroll-view class="players-bar" scroll-x enable-flex>
         <block wx:for="{{players}}" wx:key="index">
            <view class="player-slot {{item.isEmpty ? 'is-empty' : ''}} {{item.openId === selectedPlayerOpenId ? 'selected' : ''}} {{item.openId === (gameState.activePlayer || lastActivePlayer) ? 'is-active' : ''}}" bindtap="onPlayerTap" data-openid="{{item.openId}}">
               <block wx:if="{{!item.isEmpty}}">
                  <view class="p-avatar-wrap">
                     <image class="p-avatar" src="{{item.avatarUrl || '/images/default_avatar.png'}}" mode="aspectFill" />
                  </view>
                  <view class="p-info">
                     <view class="p-name">{{item.nickName}}</view>
                     <view class="p-stats">
                        <text class="stat-item">üÉè{{item.handCount}}</text>
                        <text class="stat-item">üèÜ{{item.score}}</text>
                     </view>
                  </view>
               </block>
               <block wx:else>
                  <view class="empty-seat">+</view>
               </block>
            </view>
         </block>
      </scroll-view>
      <!-- ‰∏≠Èó¥ÔºöÁâåÊ°åÂå∫Âüü (Board) -->
      <view class="game-board">
         <!-- Á©∫Âú∞ Header with Actions -->
         <view style="display: flex; justify-content: space-between; align-items: center; padding: 0 10rpx;">
            <view style="display: flex; align-items: center; gap: 16rpx;">
               <view class="area-label" style="margin-bottom:0; padding-right: 0;">
                  Á©∫Âú∞ ({{clearing.length || 0}}/10)
               </view>
               <view class="end-turn-text" bindtap="onEndTurn" wx:if="{{isMyTurn}}">ÁªìÊùü</view>
            </view>
            <view class="action-bar-inline" wx:if="{{isMyTurn}}" style="display:flex; gap:12rpx;">
               <!-- Âä®ÊÄÅÂàáÊç¢ ÊãøÂèñ ‰∏é Á°ÆËÆ§ -->
               <block wx:if="{{gameState.actionMode}}">
                  <button size="mini" class="game-btn valid-play-btn" bindtap="onConfirmSpecialAction" style="margin:0; padding:0 12rpx; font-weight:normal;">
                     ‚úÖÁ°ÆËÆ§
                  </button>
               </block>
               <block wx:else>
                  <button size="mini" class="game-btn draw-btn" bindtap="onConfirmTake" disabled="{{selectedClearingIdx === -1 && selectedClearingIdx !== -2}}" style="margin:0; padding:0 12rpx; font-weight:normal;">
                     ‚úãÊãøÂèñ
                  </button>
               </block>
               <button size="mini" class="game-btn {{instructionState === 'success' ? 'valid-play-btn' : ''}} {{gameState.actionMode && !(gameState.actionMode === 'MOLE' || gameState.actionMode === 'FREE_PLAY_BAT' || gameState.actionMode === 'PLAY_SAPLINGS' || gameState.actionMode === 'PLAY_FREE' || gameState.actionMode === 'PLAY_FREE_SPECIFIC') ? 'disabled' : ''}}" bindtap="onConfirmPlay" disabled="{{gameState.actionMode && !(gameState.actionMode === 'MOLE' || gameState.actionMode === 'FREE_PLAY_BAT' || gameState.actionMode === 'PLAY_SAPLINGS' || gameState.actionMode === 'PLAY_FREE' || gameState.actionMode === 'PLAY_FREE_SPECIFIC')}}" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  ‚úÖÊâìÂá∫
               </button>
               <button size="mini" class="game-btn secondary sapling-btn {{gameState.actionMode ? 'disabled' : ''}}" bindtap="onPlaySapling" disabled="{{gameState.actionMode}}" style="margin:0; padding:0 12rpx; font-weight:normal;">
                  üå±Ê†ëËãó
               </button>
            </view>
         </view>
         <!-- ÁâåÂ∫ì‰∏éÁ©∫Âú∞ -->
         <view style="display:flex; gap:16rpx; align-items:flex-start;">
            <view id="deck-card" style="display:flex; align-items:flex-end; padding: 40rpx 0 12rpx 0rpx; flex-shrink:0;">
               <view class="hand-card {{selectedClearingIdx === -2 ? 'selected' : ''}}" bindtap="onDrawCard" style="background:#8e44ad; color:white; border:none; position: relative; overflow: hidden; margin:0;">
                  <block wx:if="{{deckVisual && deckVisual.bgImg}}">
                     <view class="card-sprite-native" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; background-position: {{deckVisual.bgPosition}}; pointer-events: none;"></view>
                     <view class="card-body" style="background:transparent; color:white; z-index:1; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                        <view style="font-size:32rpx; font-weight:bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           ÁâåÂ∫ì
                        </view>
                        <view style="font-size:24rpx; margin-top:10rpx; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           {{deck.length || 0}}
                        </view>
                        <view style="font-size:20rpx; margin-top:8rpx; opacity:0.9; font-weight:bold; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
                           ÂõûÂêà {{currentTurn || 1}}
                        </view>
                     </view>
                  </block>
               </view>
            </view>
            <scroll-view class="clearing-scroll" scroll-x enable-flex scroll-into-view="{{clearingScrollId}}" scroll-with-animation>
               <view class="clearing-row">
                  <block wx:for="{{clearing}}" wx:key="uid">
                     <view id="clearing-{{index}}" class="hand-card clearing-card {{index === selectedClearingIdx ? 'selected' : ''}}" bindtap="onClearingCardTap" bindlongpress="onShowDetail" data-idx="{{index}}" data-type="clearing">
                        <view wx:if="{{item.bgImg}}" class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                        <view wx:else class="card-header" style="background-color: {{item.color || '#4caf50'}}">
                           <text class="card-name">{{item.name}}</text>
                        </view>
                     </view>
                  </block>
                  <block wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">
                     <view class="hand-card placeholder" wx:if="{{index >= (clearing.length || 0)}}">
                        <view class="card-body" style="background: transparent;">+</view>
                     </view>
                  </block>
                  <!-- ÊªöÂä®ÈîöÁÇπ -->
                  <view id="clearing-end-anchor" style="width: 1rpx; height: 1rpx; flex-shrink: 0;"></view>
               </view>
            </scroll-view>
         </view>
         <!-- Ê£ÆÊûóÂå∫Âüü -->
         <view class="forest-area">
            <view class="area-label" style="display:flex; justify-content:space-between; width:100%; padding-right:20rpx; box-sizing:border-box;">
               <text>{{viewingPlayerNick}}ÁöÑÊ£ÆÊûó {{!isViewingSelf ? '(‰ªÖÊü•Áúã)' : ''}}</text>
               <view class="buff-btn" bindtap="onShowBuffs" wx:if="{{isViewingSelf}}">‚ú®Buff</view>
            </view>
            <scroll-view class="forest-scroll" scroll-x enable-flex>
               <block wx:for="{{myForest}}" wx:key="_id">
                  <view class="tree-group">
                     <view class="tree-center" bindlongpress="onShowDetail" data-cardid="{{item.center.id}}">
                        <view wx:if="{{item.center.bgImg}}" class="card-sprite-native {{item.center.cssClass}}" style="background-image: url('{{item.center.bgImg}}'); background-size: {{item.center.bgSize}}; {{item.center.bgPosition ? 'background-position:' + item.center.bgPosition : ''}}"></view>
                        <view wx:else class="small-card forest-fallback">
                           {{item.center.name || 'Tree'}}
                        </view>
                     </view>
                     <!-- ÊßΩ‰ΩçÊ∏≤ÊüìÔºö‰ΩøÁî®‰Ω†ÂéüÂßãÁöÑËØ¶ÁªÜÂ∏ÉÂ±Ä -->
                     <view class="slot-pos slot-top {{selectedSlot.treeId === item._id && selectedSlot.side === 'top' ? 'selected' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="top" data-cardid="{{item.slots.top.id}}">
                        <view class="slot-card {{!item.slots.top ? 'empty' : ''}}">
                           <view wx:if="{{item.slots.top}}" class="card-sprite-native slot-crop {{item.slots.top.cssClass}}" style="background-image: url('{{item.slots.top.bgImg}}'); background-size: {{item.slots.top.bgSize}}"></view>
                        </view>
                     </view>
                     <view class="slot-pos slot-bottom {{selectedSlot.treeId === item._id && selectedSlot.side === 'bottom' ? 'selected' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="bottom" data-cardid="{{item.slots.bottom.id}}">
                        <view class="slot-card {{!item.slots.bottom ? 'empty' : ''}}">
                           <view wx:if="{{item.slots.bottom}}" class="card-sprite-native slot-crop {{item.slots.bottom.cssClass}}" style="background-image: url('{{item.slots.bottom.bgImg}}'); background-size: {{item.slots.bottom.bgSize}}"></view>
                        </view>
                     </view>
                     <view class="slot-pos slot-left {{selectedSlot.treeId === item._id && selectedSlot.side === 'left' ? 'selected' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="left" data-cardid="{{item.slots.left.id}}">
                        <view class="slot-card h-crop {{!item.slots.left ? 'empty' : ''}}">
                           <view wx:if="{{item.slots.left}}" class="card-sprite-native slot-crop {{item.slots.left.cssClass}}" style="background-image: url('{{item.slots.left.bgImg}}'); background-size: {{item.slots.left.bgSize}}"></view>
                        </view>
                     </view>
                     <view class="slot-pos slot-right {{selectedSlot.treeId === item._id && selectedSlot.side === 'right' ? 'selected' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{item._id}}" data-side="right" data-cardid="{{item.slots.right.id}}">
                        <view class="slot-card h-crop {{!item.slots.right ? 'empty' : ''}}">
                           <view wx:if="{{item.slots.right}}" class="card-sprite-native slot-crop {{item.slots.right.cssClass}}" style="background-image: url('{{item.slots.right.bgImg}}'); background-size: {{item.slots.right.bgSize}}"></view>
                        </view>
                     </view>
                  </view>
               </block>
               <!-- Ê£ÆÊûóÂç†‰ΩçÔºöÂ¶ÇÊûúÊ≤°ÊúâÊ†ëÔºåËá≥Â∞ëÊòæÁ§∫‰∏Ä‰∏™ÂºïÂØºÊ°Ü -->
               <view class="tree-group placeholder" wx:if="{{myForest.length === 0}}">
                  <view class="tree-center" style="background: rgba(255,255,255,0.05); border: 2rpx dashed rgba(255,255,255,0.2); box-shadow:none; display: flex; align-items: center; justify-content: center;">
                     <view style="color:rgba(255,255,255,0.2); font-size:40rpx;">+</view>
                  </view>
               </view>
            </scroll-view>
         </view>
      </view>
      <!-- ÂÖ®Â±ÄÂä®‰ΩúÂ±ïÁ§∫Â±Ç (Action Event Display) -->
      <view class="preview-overlay" wx:if="{{currentEvent}}" bindtap="onCloseEvent">
         <view class="preview-card-container">
            <!-- Âú∫ÊôØ1: Áé©ÂÆ∂Âá∫Áâå -->
            <block wx:if="{{currentEvent.type === 'PLAY_CARD'}}">
               <view class="event-header">
                  <image class="p-avatar-small" src="{{currentEvent.playerAvatar || '/images/default_avatar.png'}}" />
                  <text class="event-title">{{currentEvent.playerNick}} ÊâìÂá∫‰∫Ü</text>
               </view>
               <view class="main-card-display">
                  <view class="primary-flag">‰∏ªÁâå</view>
                  <view class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}"></view>
               </view>
               <view class="sub-cards-label" wx:if="{{currentEvent.subCards.length > 0}}">
                  ÊîØ‰ªòË¥πÁî®Ôºö
               </view>
               <view class="sub-cards-display" wx:if="{{currentEvent.subCards.length > 0}}">
                  <view wx:for="{{currentEvent.subCards}}" wx:key="uid" class="event-sub-card">
                     <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                  </view>
               </view>
            </block>
            <!-- Âú∫ÊôØ2: ÁâåÂ∫ìÁøªÂºÄ/Êë∏Áâå/Â•ñÂä±ÊäΩÁâå (3D Flip) -->
            <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' || currentEvent.type === 'DRAW_CARD' || currentEvent.type === 'REWARD_DRAW'}}">
               <view class="event-header">
                  <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
                  <text class="event-title">
                     <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING'}}">ÊâìÂá∫Ê†ëÊú®ÔºàÁøªÁâåÂà∞Á©∫Âú∞Ôºâ</block>
                     <block wx:elif="{{currentEvent.type === 'REWARD_DRAW'}}">
                        {{currentEvent.playerNick}} Ëé∑ÂæóÂ•ñÂä±ÊäΩÁâå ({{currentEvent.count}}Âº†)
                     </block>
                     <block wx:else>{{currentEvent.playerNick}} Ê≠£Âú®Êë∏Áâå...</block>
                  </text>
               </view>
               <view class="flip-container">
                  <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
                     <!-- ÂàùÂßãÈù¢ (0deg): ËÉåÈù¢ (Sapling) -->
                     <view class="flip-front">
                        <view class="card-sprite-native" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; background-position: {{deckVisual.bgPosition}};"></view>
                     </view>
                     <!-- ÁøªËΩ¨Èù¢ (180deg): ÂÜÖÂÆπ -->
                     <view class="flip-back">
                        <!-- Âè™ÊúâÁé©ÂÆ∂Ëá™Â∑±ÊàñÂÖ¨ÂºÄÁøªÁâåÊó∂ÊâçÁúãÂæóÂà∞Ê≠£Èù¢ÂÜÖÂÆπ -->
                        <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' || currentEvent.playerOpenId === openId}}">
                           <view wx:if="{{currentEvent.mainCard}}" class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}"></view>
                           <view wx:else class="card-sprite-native" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; background-position: {{deckVisual.bgPosition}};"></view>
                        </block>
                        <block wx:else>
                           <view class="card-sprite-native" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; background-position: {{deckVisual.bgPosition}};"></view>
                        </block>
                     </view>
                  </view>
               </view>
            </block>
            <!-- Âú∫ÊôØ3: Áé©ÂÆ∂ÊãøÂèñÂç°Áâá -->
            <block wx:if="{{currentEvent.type === 'TAKE_CARD'}}">
               <view class="event-header">
                  <image class="p-avatar-small" src="{{currentEvent.playerAvatar || '/images/default_avatar.png'}}" />
                  <text class="event-title">{{currentEvent.playerNick}} ÊãøËµ∞‰∫Ü</text>
               </view>
               <view class="main-card-display">
                  <view class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}"></view>
               </view>
            </block>
         </view>
      </view>
      <!-- Â∫ïÈÉ®ÊâãÁâå -->
      <view class="hand-area">
         <view class="hand-header">
            <view class="area-title">ÊâãÁâå ({{playerStates[openId].hand.length}})</view>
            <view class="instruction-tip {{instructionState}}">{{instructionText}}</view>
         </view>
         <scroll-view scroll-x class="hand-scroll" enable-flex>
            <view class="hand-grid">
               <block wx:for="{{playerStates[openId].hand}}" wx:key="uid">
                  <view class="hand-card {{item.uid === primarySelection ? 'primary-selected' : (item.selected ? 'payment-selected' : '')}}" bindtap="onHandTap" bindlongpress="onShowDetail" data-uid="{{item.uid}}" data-type="hand">
                     <view wx:if="{{item.uid === primarySelection}}" class="primary-flag">‰∏ªÁâå</view>
                     <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
                  </view>
               </block>
               <!-- ÊâãÁâåÂç†‰ΩçÔºöÊ®°‰ªøÁ©∫Âú∞ÈÄªËæë -->
               <block wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">
                  <view class="hand-card placeholder" wx:if="{{index >= (playerStates[openId].hand.length || 0)}}">
                     <view class="card-body" style="background: transparent;">+</view>
                  </view>
               </block>
            </view>
         </scroll-view>
      </view>
      <card-detail card-id="{{detailCardId}}" bind:close="onCloseDetail" />
   </block>
</view>