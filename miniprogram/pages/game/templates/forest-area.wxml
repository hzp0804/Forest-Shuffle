<template name="forest-area">
  <view class="forest-area {{(selectedPlayerOpenId || openId) === gameState.activePlayer ? (isViewingSelf ? 'active-turn-me' : 'active-turn-other') : ''}}" bindtouchstart="onForestTouchStart" bindtouchmove="onForestTouchMove" bindtouchend="onForestTouchEnd">
    <swiper class="forest-swiper" current="{{currentForestIndex}}" bindchange="onForestSwiperChange" duration="300" style="height: 100%; width: 100%;">
      <swiper-item wx:for="{{players}}" wx:key="openId" item-id="{{item.openId}}">
        <view class="area-label {{item.openId === openId ? 'self' : ''}}" style="display:flex; justify-content:space-between; width:100%; padding-right:20rpx; box-sizing:border-box;">
          <text>{{item.nickName}}的森林 {{item.openId !== openId ? '(仅查看)' : ''}}</text>
          <view style="display: flex; align-items: center;">
            <view class="cave-info">洞穴: {{playerStates[item.openId].cave.length || 0}}</view>
            <view class="buff-btn" bindtap="onShowBuffs" wx:if="{{item.openId === openId}}">
              ✨Buff
            </view>
          </view>
        </view>
        <scroll-view class="forest-scroll" scroll-y enable-flex scroll-top="{{forestScrollTop}}">
          <view class="forest-grid">
            <block wx:for="{{playerStates[item.openId].forest}}" wx:key="_id" wx:for-item="treeGroup">
              <view class="tree-group">
                <view class="tree-center" bindlongpress="onShowDetail" data-cardid="{{treeGroup.center.id}}" data-treeid="{{treeGroup._id}}">
                  <view wx:if="{{treeGroup.center.bgImg}}" class="card-sprite-native {{treeGroup.center.cssClass}}" style="background-image: url('{{treeGroup.center.bgImg}}'); background-size: {{treeGroup.center.bgSize}}; {{treeGroup.center.bgPosition ? 'background-position:' + treeGroup.center.bgPosition : ''}}"></view>
                  <view wx:else class="small-card forest-fallback">
                    {{treeGroup.center.name || 'Tree'}}
                  </view>
                </view>
                <!-- 槽位渲染 -->
                <view class="slot-pos slot-top {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'top' ? 'selected' : ''}} {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'top' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{treeGroup._id}}" data-side="top" data-cardid="{{treeGroup.slots.top.id}}">
                  <view class="slot-card {{!treeGroup.slots.top ? 'empty' : ''}}">
                    <view wx:if="{{treeGroup.slots.top}}" class="card-sprite-native slot-crop {{treeGroup.slots.top.cssClass}}" style="background-image: url('{{treeGroup.slots.top.bgImg}}'); background-size: {{treeGroup.slots.top.bgSize}}"></view>
                  </view>
                  <view class="stack-badge" wx:if="{{treeGroup.slots.top.max}}" catchtap="onStackTap" data-treeid="{{treeGroup._id}}" data-side="top">
                    {{treeGroup.slots.top.list.length}}
                  </view>
                </view>
                <view class="slot-pos slot-bottom {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'bottom' ? 'selected' : ''}} {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'bottom' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{treeGroup._id}}" data-side="bottom" data-cardid="{{treeGroup.slots.bottom.id}}">
                  <view class="slot-card {{!treeGroup.slots.bottom ? 'empty' : ''}}">
                    <view wx:if="{{treeGroup.slots.bottom}}" class="card-sprite-native slot-crop {{treeGroup.slots.bottom.cssClass}}" style="background-image: url('{{treeGroup.slots.bottom.bgImg}}'); background-size: {{treeGroup.slots.bottom.bgSize}}"></view>
                  </view>
                  <view class="stack-badge" wx:if="{{treeGroup.slots.bottom.max}}" catchtap="onStackTap" data-treeid="{{treeGroup._id}}" data-side="bottom">
                    {{treeGroup.slots.bottom.list.length}}
                  </view>
                </view>
                <view class="slot-pos slot-left {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'left' ? 'selected' : ''}} {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'left' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{treeGroup._id}}" data-side="left" data-cardid="{{treeGroup.slots.left.id}}">
                  <view class="slot-card h-crop {{!treeGroup.slots.left ? 'empty' : ''}}">
                    <view wx:if="{{treeGroup.slots.left}}" class="card-sprite-native slot-crop {{treeGroup.slots.left.cssClass}}" style="background-image: url('{{treeGroup.slots.left.bgImg}}'); background-size: {{treeGroup.slots.left.bgSize}}"></view>
                  </view>
                  <view class="stack-badge" wx:if="{{treeGroup.slots.left.max}}" catchtap="onStackTap" data-treeid="{{treeGroup._id}}" data-side="left">
                    {{treeGroup.slots.left.list.length}}
                  </view>
                </view>
                <view class="slot-pos slot-right {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'right' ? 'selected' : ''}} {{selectedSlot && selectedSlot.treeId === treeGroup._id && selectedSlot.side === 'right' && instructionState === 'success' ? 'can-play' : ''}}" bindtap="onSlotTap" bindlongpress="onShowDetail" data-treeid="{{treeGroup._id}}" data-side="right" data-cardid="{{treeGroup.slots.right.id}}">
                  <view class="slot-card h-crop {{!treeGroup.slots.right ? 'empty' : ''}}">
                    <view wx:if="{{treeGroup.slots.right}}" class="card-sprite-native slot-crop {{treeGroup.slots.right.cssClass}}" style="background-image: url('{{treeGroup.slots.right.bgImg}}'); background-size: {{treeGroup.slots.right.bgSize}}"></view>
                  </view>
                  <view class="stack-badge" wx:if="{{treeGroup.slots.right.max}}" catchtap="onStackTap" data-treeid="{{treeGroup._id}}" data-side="right">
                    {{treeGroup.slots.right.list.length}}
                  </view>
                </view>
              </view>
            </block>
            <!-- 森林占位：如果没有树，至少显示一个引导框 -->
            <view class="tree-group placeholder" wx:if="{{(!playerStates[item.openId].forest || playerStates[item.openId].forest.length === 0)}}" style="align-self: center; margin-top: 40rpx;">
              <view class="tree-center" style="background: rgba(255,255,255,0.05); border: 2rpx dashed rgba(255,255,255,0.2); box-shadow:none; display: flex; align-items: center; justify-content: center;">
                <view style="color:rgba(255,255,255,0.2); font-size:40rpx;">+</view>
              </view>
            </view>
          </view>
        </scroll-view>
      </swiper-item>
    </swiper>
  </view>
</template>