<template name="event-overlay">
  <view class="preview-overlay" wx:if="{{currentEvent}}">
    <view class="preview-card-container">
      <!-- åœºæ™¯1: ç©å®¶å‡ºç‰Œ -->
      <block wx:if="{{currentEvent.type === 'PLAY_CARD'}}">
        <view class="event-header">
          <image class="p-avatar-small" src="{{currentEvent.playerAvatar || '/images/default_avatar.png'}}" />
          <view class="event-title">{{currentEvent.playerNick}} æ‰“å‡ºäº†</view>
        </view>
        <view class="main-card-display">
          <view class="primary-flag">ä¸»ç‰Œ</view>
          <view class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}; background-position: {{currentEvent.mainCard.bgPosition || '0 0'}}"></view>
        </view>
        <view class="sub-cards-label" wx:if="{{currentEvent.subCards.length > 0}}">æ”¯ä»˜è´¹ç”¨ï¼š</view>
        <view class="sub-cards-display" wx:if="{{currentEvent.subCards.length > 0}}">
          <view wx:for="{{currentEvent.subCards}}" wx:key="uid" class="event-sub-card">
            <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
          </view>
        </view>
        <!-- å¥–åŠ±å’Œæ•ˆæœä¿¡æ¯å±•ç¤º -->
        <view class="reward-info" wx:if="{{currentEvent.bonusText || currentEvent.effectText || (currentEvent.triggers && currentEvent.triggers.length > 0)}}" style="margin-top: 30rpx; text-align: center;">
          <!-- å¥–åŠ±ä¼˜å…ˆæ˜¾ç¤º,ç”¨ç™½è‰² -->
          <view wx:if="{{currentEvent.bonusText}}" style="color: #FFFFFF; font-size: 28rpx; margin-bottom: 12rpx; display: flex; align-items: center; justify-content: center; text-shadow: 0 2rpx 4rpx rgba(0,0,0,0.5);">
            <view style="margin-right: 12rpx;">ğŸ</view>
            <view>å¥–åŠ±ï¼š{{currentEvent.bonusText}}</view>
          </view>
          <!-- æ•ˆæœç”¨ç™½è‰² -->
          <view wx:if="{{currentEvent.effectText}}" style="color: #FFFFFF; font-size: 28rpx; margin-bottom: 12rpx; display: flex; align-items: center; justify-content: center; text-shadow: 0 2rpx 4rpx rgba(0,0,0,0.5);">
            <view style="margin-right: 12rpx;">âœ¨</view>
            <view>æ•ˆæœï¼š{{currentEvent.effectText}}</view>
          </view>
          <!-- è§¦å‘æ•ˆæœç”¨ç™½è‰² -->
          <block wx:if="{{currentEvent.triggers && currentEvent.triggers.length > 0}}">
            <view wx:for="{{currentEvent.triggers}}" wx:key="index" style="color: #FFFFFF; font-size: 28rpx; margin-bottom: 12rpx; display: flex; align-items: center; justify-content: center; text-shadow: 0 2rpx 4rpx rgba(0,0,0,0.5);">
              <view style="margin-right: 12rpx;">âš¡</view>
              <view>è§¦å‘ã€{{item.cardName}}ã€‘ï¼š{{item.text}}</view>
            </view>
          </block>
        </view>
      </block>
      <!-- åœºæ™¯2: ç‰Œåº“ç¿»å¼€/æ‘¸ç‰Œ/å¥–åŠ±æŠ½ç‰Œ (3D Flip) -->
      <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' || currentEvent.type === 'DRAW_CARD' || currentEvent.type === 'REWARD_DRAW'}}">
        <view class="event-header">
          <!-- ç¿»ç‰Œåˆ°ç©ºåœ°ä¸æ˜¾ç¤ºç©å®¶å¤´åƒ -->
          <image class="p-avatar-small" wx:if="{{currentEvent.type !== 'DECK_TO_CLEARING' && currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
          <view class="event-title">
            <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING'}}">
              ç¿»ç‰Œ ({{currentEvent.count}}å¼ )
            </block>
            <block wx:elif="{{currentEvent.type === 'REWARD_DRAW'}}">
              {{currentEvent.playerNick}} å¥–åŠ± ({{currentEvent.count}}å¼ )
            </block>
            <block wx:else>{{currentEvent.playerNick}} æ­£åœ¨æ‘¸ç‰Œ...</block>
          </view>
        </view>
        <!-- ç¿»ç‰Œäº‹ä»¶ï¼šå±•ç¤ºæ‰€æœ‰ç¿»å‡ºçš„å¡ç‰‡ -->
        <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' && currentEvent.revealedCards}}">
          <view class="reward-cards-display">
            <view wx:for="{{currentEvent.revealedCards}}" wx:key="uid" class="reward-card-item">
              <view class="flip-container">
                <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
                  <!-- åˆå§‹é¢: èƒŒé¢ -->
                  <view class="flip-front">
                    <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}}; pointer-events: none;"></view>
                  </view>
                  <!-- ç¿»è½¬é¢: æ­£é¢ -->
                  <view class="flip-back">
                    <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}};"></view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </block>
        <!-- å¥–åŠ±æŠ½ç‰Œï¼šæ˜¾ç¤ºå¤šå¼ å¡ç‰‡ -->
        <block wx:elif="{{currentEvent.type === 'REWARD_DRAW' && currentEvent.drawnCards}}">
          <view class="reward-cards-display">
            <view wx:for="{{currentEvent.drawnCards}}" wx:key="uid" class="reward-card-item">
              <view class="flip-container">
                <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
                  <!-- åˆå§‹é¢: èƒŒé¢ -->
                  <view class="flip-front">
                    <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                  </view>
                  <!-- ç¿»è½¬é¢: åªæœ‰è‡ªå·±èƒ½çœ‹åˆ°æ­£é¢ -->
                  <view class="flip-back">
                    <block wx:if="{{currentEvent.playerOpenId === openId}}">
                      <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}};"></view>
                    </block>
                    <block wx:else>
                      <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                    </block>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </block>
        <!-- å…¶ä»–æŠ½ç‰Œäº‹ä»¶ï¼šå•å¼ å¡ç‰‡ -->
        <block wx:else>
          <view class="flip-container">
            <view class="flip-inner {{isCardFlipped ? 'is-flipped' : ''}}">
              <!-- åˆå§‹é¢ (0deg): èƒŒé¢ (Sapling) -->
              <view class="flip-front">
                <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
              </view>
              <!-- ç¿»è½¬é¢ (180deg): å†…å®¹ -->
              <view class="flip-back">
                <!-- åªæœ‰ç©å®¶è‡ªå·±æˆ–å…¬å¼€ç¿»ç‰Œæ—¶æ‰çœ‹å¾—åˆ°æ­£é¢å†…å®¹ -->
                <block wx:if="{{currentEvent.type === 'DECK_TO_CLEARING' || currentEvent.playerOpenId === openId}}">
                  <view wx:if="{{currentEvent.mainCard}}" class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}">
                    <!-- å†¬å­£å¡æç¤ºé®ç½© -->
                    <view class="winter-overlay" wx:if="{{currentEvent.isWinterReveal}}">
                      <view class="winter-count-badge">å†¬å­£å¡ {{currentEvent.winterCount}}/3</view>
                    </view>
                  </view>
                  <view wx:else class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                </block>
                <block wx:else>
                  <view class="card-sprite-native {{deckVisual.cssClass}}" style="background-image: url('{{deckVisual.bgImg}}'); background-size: {{deckVisual.bgSize}};"></view>
                </block>
              </view>
            </view>
          </view>
        </block>
      </block>
      <!-- åœºæ™¯3: ç©å®¶æ‹¿å–å¡ç‰‡ -->
      <block wx:if="{{currentEvent.type === 'TAKE_CARD'}}">
        <view class="event-header">
          <image class="p-avatar-small" src="{{currentEvent.playerAvatar || '/images/default_avatar.png'}}" />
          <view class="event-title">{{currentEvent.playerNick}} æ‹¿èµ°äº†</view>
        </view>
        <view class="main-card-display">
          <view class="card-sprite-native {{currentEvent.mainCard.cssClass}}" style="background-image: url('{{currentEvent.mainCard.bgImg}}'); background-size: {{currentEvent.mainCard.bgSize}}"></view>
        </view>
      </block>
      <!-- åœºæ™¯4: é¢å¤–å›åˆ -->
      <block wx:if="{{currentEvent.type === 'EXTRA_TURN'}}">
        <view class="event-header">
          <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
          <view class="p-avatar-small default-avatar" wx:else></view>
          <view class="event-title">
            {{currentEvent.icon || 'ğŸ‰'}} {{currentEvent.playerNick}} {{currentEvent.message}}
          </view>
        </view>
      </block>
      <!-- åœºæ™¯5: æ”¾å…¥æ´ç©´ (æµ£ç†Šè¡ŒåŠ¨) -->
      <block wx:if="{{currentEvent.type === 'CAVE_CARDS'}}">
        <view class="event-header">
          <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
          <view class="p-avatar-small default-avatar" wx:else></view>
          <view class="event-title">
            {{currentEvent.playerNick}} å°† {{currentEvent.count}} å¼ ç‰Œæ”¾å…¥æ´ç©´
          </view>
        </view>
        <view class="reward-cards-display">
          <view wx:for="{{currentEvent.cavedCards}}" wx:key="uid" class="reward-card-item">
            <view class="hand-card" style="margin: 0;">
              <view class="card-sprite-native {{item.cssClass}}" style="background-image: url('{{item.bgImg}}'); background-size: {{item.bgSize}}"></view>
            </view>
          </view>
        </view>
      </block>
      <!-- åœºæ™¯6: å›åˆåˆ‡æ¢ -->
      <block wx:if="{{currentEvent.type === 'TURN_CHANGE'}}">
        <view class="event-header">
          <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
          <view class="p-avatar-small default-avatar" wx:else></view>
          <view class="event-title" style="{{currentEvent.isMyTurn ? 'color: #90EE90; font-weight: bold;' : ''}}">
            {{currentEvent.isMyTurn ? 'ğŸ¯ è½®åˆ°ä½ äº†!' : currentEvent.playerNick + ' çš„å›åˆ'}}
          </view>
        </view>
      </block>
      <!-- åœºæ™¯7: é€šçŸ¥ -->
      <block wx:if="{{currentEvent.type === 'NOTIFICATION'}}">
        <view class="event-header">
          <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
          <view class="event-title">
            {{currentEvent.icon || 'ğŸ””'}} {{currentEvent.playerNick ? currentEvent.playerNick + ' ' : ''}}{{currentEvent.message}}
          </view>
        </view>
      </block>
    </view>
  </view>
</template>