<view class="lobby-page">
  <block wx:if="{{!isInRoom}}">
    <view class="user-card">
      <view class="user-meta">
        <image class="avatar" src="{{userProfile.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
        <view class="user-text">
          <text class="nickname">{{userProfile.nickName || 'æœªç™»å½•'}}</text>
          <text class="uid">
            {{userProfile.openId ? ('ID: ' + userProfile.openId) : 'ç™»å½•åå³å¯åˆ›å»º/åŠ å…¥æˆ¿é—´'}}
          </text>
        </view>
      </view>
    </view>
  </block>
  <page-container show="{{isInRoom}}" position="bottom" round="{{true}}" duration="300" bind:leave="onRoomContainerLeave" overlay="{{false}}" custom-style="height: 100vh; width: 100vw; background: #f8f3eb;">
    <scroll-view scroll-y class="lobby-page" style="height: 100vh; padding-top: 40rpx; box-sizing: border-box;">
      <view class="user-card">
        <view class="user-meta">
          <image class="avatar" src="{{userProfile.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
          <view class="user-text">
            <text class="nickname">{{userProfile.nickName || 'æœªç™»å½•'}}</text>
            <text class="uid">
              {{userProfile.openId ? ('ID: ' + userProfile.openId) : 'ç™»å½•åå³å¯åˆ›å»º/åŠ å…¥æˆ¿é—´'}}
            </text>
          </view>
        </view>
      </view>
      <view class="room-info" wx:if="{{isInRoom}}" style="margin-top: 32rpx;">
        <view class="room-header-row">
          <view class="room-title-block">
            <text class="label">æˆ¿é—´å·</text>
            <text class="code">{{roomCode}}</text>
          </view>
          <button size="mini" bindtap="onCopyRoomCode" class="mini-btn">å¤åˆ¶</button>
        </view>
        <view class="room-settings" wx:if="{{roomSettings}}">
          <view class="setting-item">
            <text class="setting-icon">ğŸ´</text>
            <text class="setting-text">
              ç‰Œåº“ {{roomSettings.totalCardCount || ((roomSettings.setCount || 1) * baseDeckSize)}} å¼ 
            </text>
          </view>
          <view class="setting-item">
            <text class="setting-icon">â„ï¸</text>
            <text class="setting-text">å†¬å­£å¡å€’æ•° {{roomSettings.winterStartOffset || 30}} å¼ </text>
          </view>
        </view>
        <view class="divider" style="margin: 24rpx 0; border-bottom: 2rpx dashed #e0e6df;"></view>
        <view class="seat-section">
          <text class="section-label" style="display:block; margin-bottom: 16rpx; font-weight:600; color:#334536; font-size:28rpx;">
            åº§ä½è¡¨
          </text>
          <view class="seat-grid">
            <block wx:for="{{seats}}" wx:key="id">
              <view class="seat {{item.occupant ? 'occupied' : ''}}" data-id="{{item.id}}" bindtap="onSelectSeat">
                <text class="seat-label" style="margin-bottom:8rpx;">{{item.label}}</text>
                <view class="seat-visual">
                  <image wx:if="{{item.occupant}}" class="seat-avatar" src="{{item.occupant.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
                  <view wx:else class="seat-avatar placeholder"></view>
                  <text class="seat-name">{{item.occupant ? item.occupant.nickName : 'ç©ºé—²'}}</text>
                </view>
              </view>
            </block>
          </view>
        </view>
        <view class="room-footer" style="margin-top: 40rpx; gap: 20rpx; display: flex; flex-direction: column;">
          <block wx:if="{{roomStatus === 'playing'}}">
            <button class="action-btn primary" bindtap="onContinueGame">ç»§ç»­æ¸¸æˆ</button>
          </block>
          <block wx:elif="{{isHost}}">
            <button class="action-btn primary" bindtap="onStartGame">å¼€å§‹æ¸¸æˆ</button>
          </block>
          <button class="action-btn ghost" bindtap="onExitRoom">é€€å‡ºæˆ¿é—´</button>
        </view>
      </view>
    </scroll-view>
  </page-container>
  <!-- åˆ›å»º/åŠ å…¥è¡¨å•ï¼šä»…åœ¨æœªè¿›å…¥æˆ¿é—´æ—¶æ˜¾ç¤º -->
  <block wx:if="{{!isInRoom}}">
    <view class="lobby-forms">
      <view class="section">
        <view class="section-header">
          <text class="section-title">åˆ›å»ºæˆ¿é—´</text>
          <text class="section-sub">è®¾ç½®å¥—æ•°ä¸å†¬å­£å¡è§„åˆ™</text>
        </view>
        <view class="form-item">
          <view class="label-row">
            <text class="label">ç‰Œåº“æ•°é‡</text>
            <text class="tip">ä¸å«å†¬å­£å¡</text>
          </view>
          <input class="input" type="number" placeholder="è¯·è¾“å…¥å¡ç‰Œæ€»æ•° (å¦‚ 500)" value="{{createForm.cardCount}}" bindinput="onCardCountInput" />
        </view>
        <view class="form-item">
          <text class="label">å†¬å­£å¡æ”¾ç½®</text>
          <input class="input" type="number" placeholder="ç‰Œå †åº•éƒ¨å‰å¤šå°‘å¼ å†…å¼€å§‹éšæœºæŠ½å–" value="{{createForm.winterStartOffset}}" bindinput="onWinterStartInput" />
        </view>
        <button class="action-btn primary" bindtap="onCreateRoom">åˆ›å»ºæˆ¿é—´</button>
        <text class="hint">æˆ¿é—´å·å°†è‡ªåŠ¨ç”Ÿæˆ</text>
      </view>
      <view class="section">
        <view class="section-header">
          <text class="section-title">æˆ¿é—´åˆ—è¡¨</text>
          <view class="section-sub refresh-btn" bindtap="fetchRoomList">åˆ·æ–°</view>
        </view>
        <wxs module="utils">
      var isInRoom = function(players, myId) {
        if (!players) return false;
        for (var i = 0; i < players.length; i++) {
          if (players[i] && (players[i].openId === myId || players[i].uid === myId)) return true;
        }
        return false;
      };
      module.exports.isInRoom = isInRoom;
      </wxs>
        <view class="room-list" wx:if="{{roomList && roomList.length > 0}}">
          <block wx:for="{{roomList}}" wx:key="_id">
            <view class="room-item" bindtap="onJoinRoom" data-code="{{item.roomCode}}">
              <view class="room-content-left">
                <view class="avatar-container">
                  <image class="room-host-avatar" src="{{item.players[0].avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
                  <view class="room-status-badge {{item.status}}">
                    {{item.status === 'playing' ? 'è¿›è¡Œä¸­' : 'ç­‰å¾…ä¸­'}}
                  </view>
                </view>
                <view class="room-info-text">
                  <text class="room-code">NO.{{item.roomCode}}</text>
                  <text class="room-host">æˆ¿ä¸»: {{item.players[0].nickName}}</text>
                </view>
              </view>
              <view class="room-content-right">
                <view class="player-count-badge">
                  <text class="current-count">{{item.playerCount}}</text>
                  <text class="max-count">/6</text>
                </view>
                <view class="action-buttons">
                  <view wx:if="{{userProfile.openId === item.hostOpenId || userProfile.nickName === 'ä¼šé•¿èƒ–'}}" class="icon-btn delete-btn" catchtap="onDeleteRoom" data-id="{{item._id}}">
                    <text>âœ•</text>
                  </view>
                  <view class="join-btn" catchtap="onJoinRoom" data-code="{{item.roomCode}}">
                    {{item.status === 'playing' ? (utils.isInRoom(item.players, userProfile.openId) ? 'ç»§ç»­' : 'è§‚æˆ˜') : 'åŠ å…¥'}}
                  </view>
                </view>
              </view>
            </view>
          </block>
        </view>
        <view wx:else class="empty-state">
          <text>æš‚æ—¶æ²¡æœ‰æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</text>
        </view>
      </view>
    </view>
  </block>
</view>