# 添加回合检查防止误操作

## 问题描述

在多人联机模式下,不是自己回合的玩家也可以点击手牌、空地卡牌和牌库,虽然最终操作会被阻止,但会造成困惑和误操作。

## 解决方案

在所有可能触发操作的点击事件中添加回合检查,只有在自己的回合才允许点击。

## 修改位置

### 1. onHandTap - 手牌点击

**文件**: `miniprogram/pages/game/game.js`  
**行数**: 第 342-350 行

```javascript
onHandTap(e) {
  // 只有在自己的回合才能点击手牌
  if (!this.data.isMyTurn) {
    wx.showToast({ title: "不是你的回合", icon: "none", duration: 1000 });
    return;
  }
  const updates = Utils.handleHandTap(e.currentTarget.dataset.uid, this.data);
  if (updates) this.setData(updates);
}
```

### 2. onClearingCardTap - 空地卡牌点击

**文件**: `miniprogram/pages/game/game.js`  
**行数**: 第 1441-1452 行

```javascript
onClearingCardTap(e) {
  // 只有在自己的回合才能点击空地卡牌
  if (!this.data.isMyTurn) {
    wx.showToast({ title: "不是你的回合", icon: "none", duration: 1000 });
    return;
  }
  const idx = e.currentTarget.dataset.idx;
  // Toggle selection
  this.setData({
    selectedClearingIdx: this.data.selectedClearingIdx === idx ? -1 : idx
  });
}
```

### 3. onDrawCard - 牌库点击

**文件**: `miniprogram/pages/game/game.js`  
**行数**: 第 1449-1459 行

```javascript
onDrawCard() {
  // 只有在自己的回合才能点击牌库
  if (!this.data.isMyTurn) {
    wx.showToast({ title: "不是你的回合", icon: "none", duration: 1000 });
    return;
  }
  const nextIdx = this.data.selectedClearingIdx === -2 ? -1 : -2;
  this.setData({
    selectedClearingIdx: nextIdx
  });
}
```

## isMyTurn 的计算

`isMyTurn` 是在 `processGameData` 中计算的:

```javascript
// utils/utils.js 第361行
const activePlayerId = gameState.activePlayer || res.data.activePlayer;
const isMyTurn = activePlayerId ? activePlayerId === myOpenId : true;
```

**逻辑**:

- 获取当前活跃玩家 ID (`activePlayer`)
- 比较是否等于当前玩家的 openId
- 如果相等,`isMyTurn = true`,否则为 `false`

## 用户体验

### 修改前

```
非当前玩家点击手牌
  ↓
手牌被选中(UI变化)
  ↓
尝试出牌
  ↓
被阻止(提示错误)
  ↓
用户困惑 ❌
```

### 修改后

```
非当前玩家点击手牌
  ↓
立即提示"不是你的回合" ✅
  ↓
不产生任何UI变化
  ↓
用户清楚了解状态
```

## 提示设计

### Toast 参数

- **title**: "不是你的回合"
- **icon**: "none" (不显示图标,更简洁)
- **duration**: 1000ms (1 秒,快速消失,不打扰)

### 为什么选择 Toast?

1. **轻量级**: 不阻塞界面,不需要用户确认
2. **即时反馈**: 立即告知用户为什么点击无效
3. **不干扰**: 1 秒后自动消失,不影响观看游戏

## 其他已有的回合检查

### onConfirmPlay - 出牌确认

已有检查(第 596 行):

```javascript
if (!isMyTurn) {
  wx.showToast({ title: "不是你的回合", icon: "none" });
  return;
}
```

### onConfirmTake - 拿取确认

虽然没有显式检查,但 `turnAction` 只在自己回合时有效。

## 测试场景

### 场景 1: 观看其他玩家回合

1. 玩家 A 的回合
2. 玩家 B 点击自己的手牌
3. **预期**: 提示"不是你的回合",手牌不被选中 ✅

### 场景 2: 观看其他玩家回合 - 空地

1. 玩家 A 的回合
2. 玩家 B 点击空地卡牌
3. **预期**: 提示"不是你的回合",空地卡牌不被选中 ✅

### 场景 3: 观看其他玩家回合 - 牌库

1. 玩家 A 的回合
2. 玩家 B 点击牌库
3. **预期**: 提示"不是你的回合",牌库不被选中 ✅

### 场景 4: 自己的回合

1. 玩家 A 的回合
2. 玩家 A 点击手牌/空地/牌库
3. **预期**: 正常选中,无提示 ✅

### 场景 5: 回合切换

1. 玩家 A 的回合结束
2. 切换到玩家 B
3. 玩家 A 点击操作
4. **预期**: 提示"不是你的回合" ✅
5. 玩家 B 点击操作
6. **预期**: 正常操作 ✅

## 注意事项

### 1. 查看其他玩家森林

- **不受影响**: 点击玩家头像查看森林仍然可用
- **原因**: 这是纯查看操作,不涉及游戏逻辑

### 2. 长按查看卡牌详情

- **不受影响**: `onShowDetail` 没有添加回合检查
- **原因**: 查看卡牌详情是信息查询,不是操作

### 3. 特殊行动模式

- **不受影响**: 特殊行动模式下的操作已有独立的检查逻辑
- **原因**: `actionMode` 有自己的权限控制

## 防御层级

现在有多层防御确保游戏公平:

1. **UI 层** (本次添加): 阻止非回合玩家点击
2. **逻辑层**: `onConfirmPlay` 等函数的回合检查
3. **数据层**: 服务器端的 `activePlayer` 验证

**纵深防御** = 更安全的游戏体验! 🛡️
