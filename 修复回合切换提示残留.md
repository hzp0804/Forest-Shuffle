# 修复回合切换时的提示残留问题

## 问题描述

在多人联机模式下,新回合开始时总是提示"还可以再摸一张牌",即使玩家还没有进行任何操作。

## 问题原因

### 问题流程

```
玩家A的回合:
1. 玩家A从牌库摸了一张牌
2. 设置 pendingActionToast = "还可以再摸一张牌"
3. 玩家A结束回合(没有摸第二张)
4. 回合切换到玩家B
5. 回合切换时只清除了 primarySelection 和 selectedSlot
6. pendingActionToast 没有被清除 ❌
7. 玩家B的回合开始
8. 事件队列处理完毕
9. 显示 pendingActionToast: "还可以再摸一张牌" ❌
```

### 根本原因

`pendingActionToast` 是用来提示当前玩家"还可以继续操作"的,但在回合切换时没有被清除,导致上一回合的提示残留到下一回合。

## 代码分析

### pendingActionToast 的设置位置

#### 1. executeDrawFromDeck (摸牌)

```javascript
// 第1547行
if (isEnd) {
  // 回合结束,不设置提示
} else {
  this.setData({ pendingActionToast: "还可以再摸一张牌" });
}
```

#### 2. onConfirmTake (拿牌)

```javascript
// 第1503行
if (isEnd) {
  // 回合结束,不设置提示
} else {
  this.setData({ pendingActionToast: "还可以再拿一张牌" });
}
```

### pendingActionToast 的显示位置

```javascript
// processNextEvent 第287-289行
if (this.data.pendingActionToast) {
  wx.showToast({
    title: this.data.pendingActionToast,
    icon: "none",
    duration: 1500,
  });
  this.setData({ pendingActionToast: null });
}
```

**触发时机**: 事件队列为空时

### 问题场景

#### 场景 1: 摸一张牌后结束回合

```
1. 玩家A摸牌 (drawnCount = 1)
2. isEnd = false (还可以再摸一张)
3. 设置 pendingActionToast = "还可以再摸一张牌"
4. 玩家A点击"结束回合"
5. 回合切换到玩家B
6. pendingActionToast 没有被清除 ❌
7. 玩家B的回合开始,事件队列为空
8. 显示 "还可以再摸一张牌" ❌ (错误!)
```

#### 场景 2: 拿一张牌后结束回合

```
1. 玩家A从空地拿牌 (takenCount = 1)
2. isEnd = false (还可以再拿一张)
3. 设置 pendingActionToast = "还可以再拿一张牌"
4. 玩家A点击"结束回合"
5. 回合切换到玩家B
6. pendingActionToast 没有被清除 ❌
7. 玩家B的回合开始,事件队列为空
8. 显示 "还可以再拿一张牌" ❌ (错误!)
```

## 解决方案

在回合切换时清除 `pendingActionToast`。

### 修改位置

**文件**: `miniprogram/pages/game/game.js`  
**函数**: `processGameData` 的回合切换逻辑  
**行数**: 第 195-219 行

### 修改前

```javascript
if (turnChanged) {
  // 回合切换时,重置选择状态
  processedData.primarySelection = null;
  processedData.selectedSlot = null;
  processedData.lastActivePlayer = currentActive;
  // ...
}
```

### 修改后

```javascript
if (turnChanged) {
  // 回合切换时,重置选择状态和待处理提示
  processedData.primarySelection = null;
  processedData.selectedSlot = null;
  processedData.pendingActionToast = null; // 清除上一回合的操作提示
  processedData.lastActivePlayer = currentActive;
  // ...
}
```

## 回合切换时的清理项

现在回合切换时会清理以下状态:

1. ✅ `primarySelection` - 主牌选择
2. ✅ `selectedSlot` - 槽位选择
3. ✅ `pendingActionToast` - 操作提示 (本次添加)
4. ✅ `pendingRevealCount` - 翻牌计数器

**原则**: 回合切换时应该清除所有与"当前操作"相关的临时状态。

## 测试场景

### 场景 1: 摸一张牌后结束回合

1. 玩家 A 从牌库摸一张牌
2. 不摸第二张,直接点击"结束回合"
3. 回合切换到玩家 B
4. **预期**: 玩家 B 的回合开始,无提示 ✅
5. **实际**: 无"还可以再摸一张牌"提示 ✅

### 场景 2: 拿一张牌后结束回合

1. 玩家 A 从空地拿一张牌
2. 不拿第二张,直接点击"结束回合"
3. 回合切换到玩家 B
4. **预期**: 玩家 B 的回合开始,无提示 ✅
5. **实际**: 无"还可以再拿一张牌"提示 ✅

### 场景 3: 摸两张牌后自动结束

1. 玩家 A 从牌库摸两张牌
2. 自动结束回合(isEnd = true)
3. 回合切换到玩家 B
4. **预期**: 玩家 B 的回合开始,无提示 ✅
5. **实际**: 本来就不会设置 pendingActionToast ✅

### 场景 4: 摸一张牌后继续摸第二张

1. 玩家 A 从牌库摸一张牌
2. 提示"还可以再摸一张牌" ✅
3. 玩家 A 摸第二张牌
4. 自动结束回合
5. **预期**: 在本回合内显示提示,不影响下一回合 ✅

## 相关状态管理

### 状态生命周期

#### primarySelection (主牌选择)

- **创建**: 点击手牌时
- **清除**:
  - 出牌后
  - 回合切换时

#### selectedSlot (槽位选择)

- **创建**: 点击槽位时
- **清除**:
  - 出牌后
  - 主牌变更时
  - 回合切换时

#### pendingActionToast (操作提示)

- **创建**:
  - 摸一张牌后(还可以再摸一张)
  - 拿一张牌后(还可以再拿一张)
- **清除**:
  - 显示提示后
  - 回合切换时 (本次添加)

#### selectedClearingIdx (空地/牌库选择)

- **创建**:
  - 点击空地卡牌时
  - 点击牌库时
- **清除**:
  - 摸牌/拿牌后 (最近添加)
  - 手动取消选择时

## 总结

这是一个典型的**状态清理不完整**问题:

- ❌ **错误**: 只清理了部分状态,遗漏了 `pendingActionToast`
- ✅ **正确**: 回合切换时清理所有临时状态

**教训**: 在状态转换(如回合切换)时,要全面检查所有临时状态,确保都被正确清理。
