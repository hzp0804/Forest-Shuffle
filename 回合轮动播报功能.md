# 回合轮动播报功能

## 需求

将回合切换从 Toast 改为事件播报,显示"谁谁谁的回合",带上玩家头像。

## 实现内容

### 1. 创建 TURN_CHANGE 事件 (`miniprogram/pages/game/game.js`)

#### 1.1 在回合切换时创建事件

```javascript
// 在 processGameUpdate 函数中
if (turnChanged) {
  // ... 其他逻辑 ...

  // 创建回合切换事件
  const activePlayer = this.data.players.find(
    (p) => p.openId === currentActive
  );
  if (activePlayer) {
    const turnChangeEvent = {
      type: "TURN_CHANGE",
      playerOpenId: currentActive,
      playerNick: activePlayer.nickName || "玩家",
      playerAvatar: activePlayer.avatarUrl || "",
      isMyTurn: currentActive === this.data.openId,
      timestamp: Date.now(),
    };
    this.addToEventQueue(turnChangeEvent);
  }
}
```

#### 1.2 删除 pendingTurnToast 逻辑

- 删除了 `processNextEvent` 中处理 `pendingTurnToast` 的 Toast 代码
- 不再使用 `wx.showToast` 显示"轮到你了!"
- 改为使用事件队列统一处理

#### 1.3 添加震动提示

```javascript
// 在 processNextEvent 中
if (event.type === "TURN_CHANGE" && event.isMyTurn) {
  wx.vibrateShort({ type: "medium" });
}
```

### 2. UI 显示 (`miniprogram/pages/game/game.wxml`)

```xml
<!-- 场景6: 回合切换 -->
<block wx:if="{{currentEvent.type === 'TURN_CHANGE'}}">
   <view class="event-header">
      <image class="p-avatar-small" wx:if="{{currentEvent.playerAvatar}}" src="{{currentEvent.playerAvatar}}" />
      <view class="p-avatar-small default-avatar" wx:else></view>
      <text class="event-title" style="{{currentEvent.isMyTurn ? 'color: #90EE90; font-weight: bold;' : ''}}">
         {{currentEvent.isMyTurn ? '🎯 轮到你了！' : currentEvent.playerNick + ' 的回合'}}
      </text>
   </view>
</block>
```

## 显示效果

### 轮到自己时:

```
[玩家头像] 🎯 轮到你了！ (绿色加粗)
```

- 震动提示
- 绿色文字,加粗显示
- 带有目标图标 🎯

### 轮到其他玩家时:

```
[玩家头像] 玩家A 的回合 (普通白色)
```

- 无震动
- 普通白色文字
- 显示玩家名称

## 事件数据结构

```javascript
{
  type: 'TURN_CHANGE',
  playerOpenId: '当前回合玩家的openId',
  playerNick: '玩家昵称',
  playerAvatar: '玩家头像URL',
  isMyTurn: true/false,  // 是否轮到自己
  timestamp: 时间戳
}
```

## 与原 Toast 的区别

| 特性         | 原 Toast 方式  | 新事件播报方式     |
| ------------ | -------------- | ------------------ |
| 显示方式     | Toast 弹窗     | 事件动画           |
| 玩家信息     | 无             | 显示头像和名字     |
| 震动提示     | 有             | 有(保留)           |
| 显示时长     | 1500ms         | 1500ms             |
| 其他玩家回合 | 不显示         | 显示"XXX 的回合"   |
| 视觉效果     | 简单文字       | 带头像的卡片式展示 |
| 一致性       | 独立于事件系统 | 统一在事件系统中   |

## 优势

1. **视觉一致性**: 所有游戏事件都通过统一的动画系统展示
2. **信息更丰富**: 显示玩家头像和名字,更直观
3. **更好的区分**: 轮到自己时用绿色加粗,更醒目
4. **全局可见**: 所有玩家都能看到回合切换,不只是当前玩家
5. **更好的体验**: 卡片式展示比 Toast 更美观

## 测试建议

### 测试场景:

1. 开始游戏,检查第一个玩家的回合是否正确显示
2. 结束回合,检查是否显示下一个玩家的回合
3. 轮到自己时,检查是否:
   - 显示"🎯 轮到你了!"
   - 文字为绿色加粗
   - 有震动提示
4. 轮到其他玩家时,检查是否:
   - 显示"XXX 的回合"
   - 文字为普通白色
   - 无震动
5. 检查玩家头像是否正确显示
6. 检查事件播报的时长是否合适(1500ms)
