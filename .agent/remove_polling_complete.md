# å®Œå…¨ç§»é™¤è½®è¯¢æœºåˆ¶ - å®ŒæˆæŠ¥å‘Š âœ…

## ğŸ“ æ”¹åŠ¨æ€»ç»“

### å·²ç§»é™¤çš„ä»£ç 

#### 1. **ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ¸…ç†**

```javascript
// æ”¹åŠ¨å‰
onHide() {
  this.stopWatcher();
  this.stopPolling(); // âŒ å·²ç§»é™¤
}
onUnload() {
  this.stopWatcher();
  this.stopPolling(); // âŒ å·²ç§»é™¤
}

// æ”¹åŠ¨å
onHide() {
  this.stopWatcher();
}
onUnload() {
  this.stopWatcher();
}
```

#### 2. **é”™è¯¯å¤„ç†æ”¹ä¸ºè‡ªåŠ¨é‡è¿**

```javascript
// æ”¹åŠ¨å‰
onError: (err) => {
  console.error("âŒ å®æ—¶ç›‘å¬é”™è¯¯:", err);
  wx.showToast({ title: "è¿æ¥æ–­å¼€,åˆ‡æ¢åˆ°è½®è¯¢æ¨¡å¼", icon: "none" });

  // é™çº§åˆ°è½®è¯¢æ¨¡å¼ âŒ
  this.stopWatcher();
  this.startPolling(); // âŒ å·²ç§»é™¤
};

// æ”¹åŠ¨å
onError: (err) => {
  console.error("âŒ å®æ—¶ç›‘å¬é”™è¯¯:", err);

  // å°è¯•é‡æ–°è¿æ¥ âœ…
  this.stopWatcher();

  wx.showToast({
    title: "è¿æ¥æ–­å¼€,æ­£åœ¨é‡è¿...",
    icon: "none",
    duration: 2000,
  });

  // 3ç§’åå°è¯•é‡æ–°å»ºç«‹è¿æ¥
  setTimeout(() => {
    console.log("ğŸ”„ å°è¯•é‡æ–°è¿æ¥...");
    this.initGameWatcher();
  }, 3000);
};
```

#### 3. **å®Œå…¨åˆ é™¤çš„æ–¹æ³•**

##### âŒ startPolling()

```javascript
// å·²åˆ é™¤ - å…±14è¡Œä»£ç 
startPolling() {
  this.stopPolling();
  if (!this.data.roomId) return;

  console.log("â° å¯åŠ¨è½®è¯¢æ¨¡å¼(é™çº§æ–¹æ¡ˆ)");
  this.queryGameData(this.data.roomId);
  this.pollingTimer = setInterval(() => {
    this.queryGameData(this.data.roomId);
  }, 2000);
}
```

##### âŒ stopPolling()

```javascript
// å·²åˆ é™¤ - å…±10è¡Œä»£ç 
stopPolling() {
  if (this.pollingTimer) {
    clearInterval(this.pollingTimer);
    this.pollingTimer = null;
  }
  if (this.turnToastTimer) {
    clearTimeout(this.turnToastTimer);
    this.turnToastTimer = null;
  }
}
```

##### âŒ queryGameData()

```javascript
// å·²åˆ é™¤ - å…±12è¡Œä»£ç 
async queryGameData(roomId) {
  try {
    const res = await db.collection("rooms").doc(roomId).get();
    this.processGameUpdate(res.data);
  } catch (e) {
    console.error("æŸ¥è¯¢æ¸¸æˆæ•°æ®å¤±è´¥:", e);
  }
}
```

## ğŸ“Š ä»£ç ç»Ÿè®¡

| é¡¹ç›®             | æ•°é‡         |
| ---------------- | ------------ |
| **åˆ é™¤çš„æ–¹æ³•**   | 3 ä¸ª         |
| **åˆ é™¤çš„ä»£ç è¡Œ** | ~40 è¡Œ       |
| **ä¿®æ”¹çš„æ–¹æ³•**   | 3 ä¸ª         |
| **æ–°å¢çš„é€»è¾‘**   | è‡ªåŠ¨é‡è¿æœºåˆ¶ |

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### æ¶æ„ç®€åŒ–

- âœ… **å•ä¸€æ•°æ®æº**: åªä½¿ç”¨å®æ—¶æ¨é€
- âœ… **ä»£ç æ›´ç®€æ´**: å‡å°‘ 40+è¡Œä»£ç 
- âœ… **é€»è¾‘æ›´æ¸…æ™°**: ç§»é™¤é™çº§é€»è¾‘
- âœ… **ç»´æŠ¤æ›´å®¹æ˜“**: ä¸éœ€è¦ç»´æŠ¤ä¸¤å¥—æœºåˆ¶

### æ€§èƒ½æå‡

| æŒ‡æ ‡       | ä¼˜åŒ–å‰(è½®è¯¢) | ä¼˜åŒ–å(çº¯æ¨é€) |
| ---------- | ------------ | -------------- |
| å“åº”å»¶è¿Ÿ   | 0-2 ç§’       | <100ms         |
| æ•°æ®åº“è¯»å– | 30 æ¬¡/åˆ†é’Ÿ   | 0 æ¬¡(çº¯æ¨é€)   |
| ç½‘ç»œè¯·æ±‚   | æŒç»­è½®è¯¢     | äº‹ä»¶é©±åŠ¨       |
| èµ„æºæ¶ˆè€—   | ä¸­ç­‰         | æä½           |

### å¯é æ€§æå‡

- âœ… **è‡ªåŠ¨é‡è¿**: è¿æ¥æ–­å¼€å 3 ç§’è‡ªåŠ¨é‡è¿
- âœ… **ç”¨æˆ·æç¤º**: æ¸…æ™°çš„è¿æ¥çŠ¶æ€æç¤º
- âœ… **æ— æ„ŸçŸ¥æ¢å¤**: é‡è¿æˆåŠŸåè‡ªåŠ¨ç»§ç»­

## ğŸ”§ æ–°çš„é”™è¯¯å¤„ç†æœºåˆ¶

### è‡ªåŠ¨é‡è¿æµç¨‹

```
å®æ—¶æ¨é€è¿æ¥ â†’ æ­£å¸¸è¿è¡Œ
     â†“ (ç½‘ç»œæ–­å¼€)
  onError è§¦å‘
     â†“
  åœæ­¢å½“å‰ç›‘å¬
     â†“
  æ˜¾ç¤º"æ­£åœ¨é‡è¿..."
     â†“
  ç­‰å¾… 3 ç§’
     â†“
  é‡æ–°è°ƒç”¨ initGameWatcher()
     â†“
  å»ºç«‹æ–°çš„æ¨é€è¿æ¥
     â†“
  æ¢å¤æ­£å¸¸è¿è¡Œ
```

### é‡è¿ç­–ç•¥

- **é‡è¿å»¶è¿Ÿ**: 3 ç§’(é¿å…é¢‘ç¹é‡è¿)
- **é‡è¿æ¬¡æ•°**: æ— é™åˆ¶(æŒç»­å°è¯•)
- **ç”¨æˆ·æç¤º**: æ˜¾ç¤ºé‡è¿çŠ¶æ€
- **æ•°æ®å®Œæ•´æ€§**: é‡è¿åè‡ªåŠ¨åŒæ­¥æœ€æ–°æ•°æ®

## ğŸ“ å½“å‰æ¶æ„

### æ•°æ®æµ

```
æ•°æ®åº“å˜åŒ– â†’ watch API â†’ onChange å›è°ƒ â†’ processGameUpdate() â†’ UIæ›´æ–°
                              â†“ (é”™è¯¯)
                           onError å›è°ƒ â†’ 3ç§’åé‡è¿
```

### æ ¸å¿ƒæ–¹æ³•

1. **initGameWatcher()** - åˆå§‹åŒ–å®æ—¶ç›‘å¬
2. **stopWatcher()** - åœæ­¢ç›‘å¬
3. **processGameUpdate()** - å¤„ç†æ•°æ®æ›´æ–°

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç½‘ç»œçŠ¶æ€

- å®æ—¶æ¨é€ä¾èµ–ç½‘ç»œè¿æ¥
- ç½‘ç»œä¸ç¨³å®šæ—¶ä¼šé¢‘ç¹é‡è¿
- å»ºè®®åœ¨ç½‘ç»œè¾ƒå¥½çš„ç¯å¢ƒä¸‹æ¸¸æˆ

### 2. å¹¶å‘é™åˆ¶

- å¾®ä¿¡äº‘æ•°æ®åº“ watch æœ‰è¿æ¥æ•°é™åˆ¶
- å•ä¸ªå°ç¨‹åºå®ä¾‹æœ€å¤š 20 ä¸ªå¹¶å‘è¿æ¥
- å½“å‰æ¯ä¸ªæ¸¸æˆé¡µé¢å ç”¨ 1 ä¸ªè¿æ¥

### 3. æ•°æ®åŒæ­¥

- é‡è¿åä¼šè‡ªåŠ¨æ¥æ”¶æœ€æ–°æ•°æ®
- ä¸ä¼šä¸¢å¤±é‡è¿æœŸé—´çš„æ•°æ®å˜åŒ–
- watch API ä¿è¯æ•°æ®ä¸€è‡´æ€§

## ğŸ§ª æµ‹è¯•å»ºè®®

### åŸºç¡€åŠŸèƒ½æµ‹è¯•

- [ ] æ­£å¸¸è¿›å…¥æ¸¸æˆ,æŸ¥çœ‹æ˜¯å¦æ”¶åˆ°å®æ—¶æ¨é€
- [ ] å¤šäººæ¸¸æˆ,æµ‹è¯•æ•°æ®åŒæ­¥
- [ ] å‡ºç‰Œã€æ‘¸ç‰Œç­‰æ“ä½œæ˜¯å¦å®æ—¶æ›´æ–°

### å¼‚å¸¸æƒ…å†µæµ‹è¯•

- [ ] æ–­å¼€ç½‘ç»œ,è§‚å¯Ÿé‡è¿æç¤º
- [ ] æ¢å¤ç½‘ç»œ,ç¡®è®¤è‡ªåŠ¨é‡è¿æˆåŠŸ
- [ ] é•¿æ—¶é—´æ¸¸æˆ,æµ‹è¯•è¿æ¥ç¨³å®šæ€§
- [ ] å¿«é€Ÿåˆ‡æ¢å‰åå°,æµ‹è¯•ç›‘å¬æ¢å¤

### æ€§èƒ½æµ‹è¯•

- [ ] æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—,ç¡®è®¤æ— è½®è¯¢è¯·æ±‚
- [ ] ç›‘æ§æ•°æ®åº“è¯»å–æ¬¡æ•°
- [ ] æµ‹è¯•å¤šäººåŒæ—¶æ“ä½œçš„å“åº”é€Ÿåº¦

## ğŸ“± æ§åˆ¶å°æ—¥å¿—

### æ­£å¸¸æµç¨‹

```
ğŸ”” å¼€å§‹å®æ—¶ç›‘å¬æ¸¸æˆæ•°æ®: room_xxx
ğŸ“¡ æ”¶åˆ°å®æ—¶æ¨é€: {...}
```

### é‡è¿æµç¨‹

```
âŒ å®æ—¶ç›‘å¬é”™è¯¯: {...}
ğŸ”• åœæ­¢å®æ—¶ç›‘å¬
ğŸ”„ å°è¯•é‡æ–°è¿æ¥...
ğŸ”” å¼€å§‹å®æ—¶ç›‘å¬æ¸¸æˆæ•°æ®: room_xxx
```

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¼˜åŒ–,æˆ‘ä»¬:

1. âœ… **å®Œå…¨ç§»é™¤äº†è½®è¯¢æœºåˆ¶** - åˆ é™¤ 3 ä¸ªæ–¹æ³•,çº¦ 40 è¡Œä»£ç 
2. âœ… **å®ç°äº†è‡ªåŠ¨é‡è¿** - ç½‘ç»œæ–­å¼€åè‡ªåŠ¨æ¢å¤
3. âœ… **ç®€åŒ–äº†æ¶æ„** - å•ä¸€æ•°æ®æº,é€»è¾‘æ›´æ¸…æ™°
4. âœ… **æå‡äº†æ€§èƒ½** - é›¶è½®è¯¢è¯·æ±‚,å®æ—¶å“åº”

**ç°åœ¨é¡¹ç›®å®Œå…¨åŸºäºå®æ—¶æ¨é€,å“åº”é€Ÿåº¦æ›´å¿«,èµ„æºæ¶ˆè€—æ›´ä½!** ğŸš€

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡äº‘æ•°æ®åº“ watch API æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/realtime.html)
- [å®æ—¶æ¨é€ä¼˜åŒ–æ€»ç»“](.agent/realtime_push_optimization_summary.md)

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `miniprogram/pages/game/game.js` - æ¸¸æˆé¡µé¢(å·²ä¼˜åŒ–)
- `miniprogram/pages/lobby/lobby.js` - å¤§å…é¡µé¢(å·²ä¼˜åŒ–)
