# 翻牌逻辑测试场景

## 测试目的

验证重构后的翻牌逻辑是否正确工作，确保：

1. 回合开始时计数器正确初始化为 0
2. 每次打出树木时计数器正确累加
3. 奖励行动中打出的树木也能正确计数
4. 回合结束时根据计数器正确翻牌
5. 新回合开始时计数器重置

## 测试场景

### 场景 1: 单次打出树木

**操作步骤**:

1. 新回合开始
2. 打出一棵树木（如橡树）
3. 回合结束

**预期结果**:

- 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
- 控制台输出: `🌳 普通模式打出树木，计数器+1。当前总计: 1`
- 控制台输出: `🎴 回合结束，开始翻牌: 1 张`
- 空地增加 1 张卡牌

### 场景 2: 连续打出多棵树木（奖励行动）

**操作步骤**:

1. 新回合开始
2. 打出一棵树木（触发奖励行动，如鼼鼠效果）
3. 在奖励行动中继续打出树木
4. 回合结束

**预期结果**:

- 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
- 控制台输出: `🌳 普通模式打出树木，计数器+1。当前总计: 1`
- 控制台输出: `🕒 有后续行动（奖励或额外回合），翻牌推迟到回合结束`
- 控制台输出: `🌳 特殊模式打出树木，计数器+1。当前总计: 2`
- 控制台输出: `📊 回合结束翻牌统计: { 本回合打出树木数: 2, 数据库累积计数: 2 }`
- 控制台输出: `🎴 回合结束，开始翻牌: 2 张`
- 空地增加 2 张卡牌

### 场景 3: 混合打出树木和非树木

**操作步骤**:

1. 新回合开始
2. 打出一棵树木
3. 在奖励行动中打出一张非树木卡牌（如动物卡）
4. 回合结束

**预期结果**:

- 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
- 控制台输出: `🌳 普通模式打出树木，计数器+1。当前总计: 1`
- 控制台输出: `⚠️ 非树木卡牌，未增加计数`
- 控制台输出: `🎴 回合结束，开始翻牌: 1 张`
- 空地增加 1 张卡牌（只有树木触发翻牌）

### 场景 4: 多回合测试

**操作步骤**:

1. 第一回合：打出 2 棵树木
2. 第二回合：打出 1 棵树木
3. 第三回合：不打树木

**预期结果**:

- **第一回合**:
  - 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
  - 控制台输出: `🎴 回合结束，开始翻牌: 2 张`
  - 空地增加 2 张卡牌
- **第二回合**:
  - 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
  - 控制台输出: `🎴 回合结束，开始翻牌: 1 张`
  - 空地增加 1 张卡牌
- **第三回合**:
  - 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
  - 不触发翻牌（计数器为 0）

### 场景 5: 树苗模式测试

**操作步骤**:

1. 新回合开始
2. 触发树苗模式（ACTION_PLAY_SAPLINGS）
3. 打出树苗
4. 回合结束

**预期结果**:

- 控制台输出: `🔄 回合切换，翻牌计数器已重置为 0`
- 控制台输出: `🌳 特殊模式打出树木，计数器+1。当前总计: 1`
- 控制台输出: `🎴 回合结束，开始翻牌: 1 张`
- 空地增加 1 张卡牌（树苗也算作树木）

## 调试技巧

### 查看控制台日志

在微信开发者工具中打开控制台，查看以下关键日志：

- `🔄 回合切换，翻牌计数器已重置为 0` - 回合开始
- `🌳 普通模式打出树木，计数器+1` - 普通模式打树木
- `🌳 特殊模式打出树木，计数器+1` - 特殊模式打树木
- `⚠️ 非树木卡牌，未增加计数` - 打出非树木
- `🕒 有后续行动，翻牌推迟到回合结束` - 有奖励行动
- `📊 回合结束翻牌统计` - 回合结束统计
- `🎴 回合结束，开始翻牌` - 开始翻牌
- `✅ 翻牌完成` - 翻牌完成
- `🔄 翻牌计数器已重置为 0` - 计数器重置

### 断点调试位置

1. `processGameUpdate` 方法 - 第 202 行（回合切换，初始化计数器）
2. `onConfirmPlay` 方法 - 第 1028 行（特殊模式累加计数器）
3. `onConfirmPlay` 方法 - 第 1203 行（普通模式累加计数器）
4. `finalizeAction` 方法 - 第 1582 行（回合结束翻牌）

## 常见问题排查

### 问题 1: 翻牌数量不正确

**排查步骤**:

1. 检查控制台日志，确认每次打出树木时计数器是否正确累加
2. 检查是否有非树木卡牌被误判为树木
3. 检查回合结束时的统计日志

### 问题 2: 计数器未重置

**排查步骤**:

1. 检查回合切换时是否输出了 `🔄 回合切换，翻牌计数器已重置为 0`
2. 检查 `turnChanged` 变量是否正确判断
3. 检查 `activePlayer` 和 `turnCount` 是否正确更新

### 问题 3: 奖励行动中的树木未计数

**排查步骤**:

1. 检查特殊模式分支是否正确执行
2. 检查 `isPlayedAsTree` 变量是否正确判断
3. 检查 `gameState.actionMode` 是否正确设置

## 性能监控

在测试过程中，注意观察以下性能指标：

- 翻牌动画是否流畅
- 计数器累加是否有延迟
- 回合切换是否及时
- 日志输出是否过多影响性能

## 回归测试

确保以下功能未受影响：

- 摸牌功能
- 打出非树木卡牌
- 空地满 10 张自动清空
- 得分计算
- 特殊效果触发
