# 功能实现总结

## 1. 出牌动画展示奖励和效果 ✅

### 需求

在出牌时,如果触发奖励或者效果,需要在出牌动画中展示具体内容,让玩家清楚地看到打出这张牌获得了什么。

### 实现内容

#### 1.1 增强 `calculateTriggerEffects` 函数 (`miniprogram/utils/reward.js`)

- 添加 `triggers` 数组,记录每个触发效果的详细信息
- 每个触发效果包含:
  - `cardName`: 触发效果的卡牌名称
  - `text`: 效果描述(如"摸 2 张牌")

#### 1.2 修改 `PLAY_CARD` 事件数据 (`miniprogram/pages/game/game.js`)

在三个创建 `PLAY_CARD` 事件的地方添加奖励和效果信息:

- `bonusText`: 奖励文本(如"摸 1 张牌")
- `effectText`: 效果文本(如"获得新的回合")
- `triggers`: 触发效果列表(如 `[{cardName: "鸡油菌", text: "摸1张牌"}]`)

#### 1.3 更新 WXML 模板 (`miniprogram/pages/game/game.wxml`)

在 `PLAY_CARD` 事件展示区域添加奖励信息显示:

- 🎁 **奖励**(优先显示): **绿色**文本显示 bonusText
- ✨ **效果**: **蓝色**文本显示 effectText
- ⚡ **触发**: **金色**文本显示每个触发效果(格式: "触发【卡牌名】: 效果描述")

**显示顺序**: 奖励 → 效果 → 触发效果(从上到下)

#### 1.4 Bug 修复 (`miniprogram/utils/reward.js`)

- 删除了第 21 行不完整的代码 `if (!isBonus) result`,这是一个遗留 bug
- 这个 bug 可能导致某些情况下奖励计算异常

### 效果

玩家在出牌动画中可以清楚地看到:

- 主牌触发的奖励(需要颜色匹配) - **绿色,最显眼**
- 主牌的效果 - 蓝色
- 森林中其他卡牌触发的常驻效果 - 金色

---

## 2. 水田鼠打出树苗逻辑 ✅

### 需求

处理水田鼠"立即打出任意数量的树苗"的逻辑,类似鼹鼠,但限制只能打树苗,且需要支付费用。

### 实现内容

#### 2.1 修改验证逻辑 (`miniprogram/utils/validate.js`)

**修改 1: 费用验证**

- 将 `ACTION_PLAY_SAPLINGS` 模式加入需要验证费用的模式列表
- 与 `ACTION_MOLE` 模式一样,跳过特殊模式的默认处理,继续执行正常的费用验证

**修改 2: 不显示奖励和效果**

- 在 `ACTION_PLAY_SAPLINGS` 模式下不显示原卡牌的奖励和效果
- 因为卡牌会被转换为树苗,原有的奖励和效果不会触发

**修改 3: 特殊提示文本**

- 添加水田鼠模式的特殊提示前缀
- 格式: "打出树苗 | 【费用】: X"

#### 2.2 已有的转换逻辑 (`miniprogram/pages/game/game.js`)

代码中已经存在将任何卡牌转换为树苗的逻辑(第 817-830 行):

```javascript
if (gameState.actionMode === "ACTION_PLAY_SAPLINGS") {
  primaryCard = {
    ...primaryCard,
    name: "树苗",
    type: CARD_TYPES.TREE,
    species: [{ type: CARD_TYPES.TREE, cost: 0 }],
    effect: "树苗:仅作为一棵树木计算",
    bonus: "",
    scoreConfig: null,
    effectConfig: null,
    bonusConfig: null,
    isSapling: true,
  };
}
```

### 工作流程

1. 玩家打出水田鼠,触发 `ACTION_PLAY_SAPLINGS` 模式
2. 玩家选择手牌作为树苗打出
3. 系统验证是否支付了正确的费用(树苗费用为 0,但仍需选择 0 张支付卡)
4. 卡牌被转换为树苗并放入森林
5. 可以继续打出更多树苗,直到玩家点击"跳过"

### 与鼹鼠的区别

- **鼹鼠** (`ACTION_MOLE`): 可以打出任何牌,需要支付费用,会触发奖励和效果
- **水田鼠** (`ACTION_PLAY_SAPLINGS`): 只能打出树苗,需要支付费用(0 张),不触发原牌的奖励和效果

---

## 测试建议

### 测试场景 1: 出牌动画展示

1. 打出一张有奖励的卡牌(如冷杉),检查是否显示"🎁 奖励: 获得新的回合"(绿色)
2. 打出一张有效果的卡牌(如渡鸦),检查是否显示"✨ 效果: 获得 1 张牌"(蓝色)
3. 打出同时有奖励和效果的卡牌(如瑞士石松),检查是否同时显示奖励和效果,且奖励在上
4. 在森林中有鸡油菌的情况下打出树木,检查是否显示"⚡ 触发【鸡油菌】: 摸 1 张牌"(金色)

### 测试场景 2: 水田鼠打出树苗

1. 打出水田鼠,进入树苗模式
2. 选择一张手牌,检查提示是否显示"打出树苗 | 【费用】: 0"
3. 确认打出,检查卡牌是否变成树苗
4. 继续打出多张树苗
5. 点击"跳过"结束树苗模式

---

## 修复的 Bug

### Bug 1: reward.js 中的不完整代码

- **问题**: 第 21 行有不完整的代码 `if (!isBonus) result`
- **影响**: 可能导致某些情况下奖励计算异常
- **修复**: 删除了这行代码

### Bug 2: 同时有奖励和效果的卡牌没有播报

- **原因**: 上述不完整代码导致的潜在问题
- **修复**: 删除不完整代码后,奖励和效果都能正常显示
