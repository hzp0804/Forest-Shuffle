# 森林树木排序功能

## 功能描述

在森林显示区域,将相同名称的树木排列在一起,便于玩家查看和管理自己的森林。

## 实现方式

### 修改位置

**文件**: `miniprogram/utils/utils.js`  
**函数**: `enrichForest`  
**行数**: 第 129-165 行

### 排序逻辑

#### 1. 先富化数据

```javascript
const enrichedForest = forest.map((node) => {
  // ... 富化逻辑
});
```

#### 2. 按树木名称排序

```javascript
enrichedForest.sort((a, b) => {
  const nameA = a.center?.name || "";
  const nameB = b.center?.name || "";
  return nameA.localeCompare(nameB, "zh-CN");
});
```

#### 3. 返回排序后的森林

```javascript
return enrichedForest;
```

### 排序规则

#### 使用 localeCompare

- **方法**: `String.prototype.localeCompare()`
- **语言**: `'zh-CN'` (简体中文)
- **效果**: 按中文拼音顺序排序

#### 排序示例

```
排序前:
[橡树, 桦树, 橡树, 椴树, 桦树, 橡树]

排序后:
[桦树, 桦树, 椴树, 橡树, 橡树, 橡树]
```

## 效果展示

### 修改前 ❌

```
森林显示:
[树1: 欧洲七叶树]
[树2: 桦树]
[树3: 欧洲七叶树]
[树4: 山毛榉]
[树5: 桦树]
[树6: 欧洲七叶树]

问题: 相同的树木分散在各处,不便查看
```

### 修改后 ✅

```
森林显示:
[树1: 山毛榉]
[树2: 桦树]
[树3: 桦树]
[树4: 欧洲七叶树]
[树5: 欧洲七叶树]
[树6: 欧洲七叶树]

优点: 相同的树木排在一起,一目了然
```

## 用户体验改进

### 1. 便于查看

- ✅ 快速找到特定树木
- ✅ 清楚知道每种树木的数量
- ✅ 方便规划下一步策略

### 2. 便于计分

- ✅ 欧洲七叶树: 容易看出有几棵(阶梯计分)
- ✅ 山毛榉: 容易判断是否达到 4 棵(条件计分)
- ✅ 椴树: 容易比较数量(多数计分)

### 3. 便于管理

- ✅ 紫木蜂效果: 容易找到山毛榉和欧洲七叶树
- ✅ 槽位规划: 相同树木在一起,方便比较槽位使用情况

## 排序稳定性

### 相同名称的树木

对于相同名称的树木,保持原有的相对顺序(稳定排序)。

```javascript
// JavaScript的 Array.sort() 在现代浏览器中是稳定的
// 相同名称的树木会保持它们被打出的顺序
```

### 示例

```
打出顺序: 桦树A, 桦树B, 桦树C
排序后: 桦树A, 桦树B, 桦树C (保持顺序)
```

## 性能考虑

### 时间复杂度

- **排序**: O(n log n)
- **n**: 森林中树木的数量

### 性能影响

- **森林大小**: 通常不超过 20 棵树
- **排序耗时**: 可忽略不计 (<1ms)
- **用户体验**: 无感知延迟

### 优化

排序在数据富化之后进行,只在以下情况触发:

1. 游戏数据更新时
2. 切换查看其他玩家森林时

## 中文排序规则

### localeCompare 的优势

1. **正确处理中文**: 按拼音排序
2. **多音字处理**: 使用常用读音
3. **标准化**: 符合中文排序习惯

### 排序示例

```
按拼音排序:
- 桦树 (huà)
- 椴树 (duàn)
- 梧桐 (wú)
- 橡树 (xiàng)
- 银杉 (yín)

结果:
椴树 < 桦树 < 梧桐 < 橡树 < 银杉
```

## 特殊情况处理

### 1. 空森林

```javascript
if (!Array.isArray(forest)) return [];
// 返回空数组,不会报错
```

### 2. 树木名称为空

```javascript
const nameA = a.center?.name || "";
// 使用空字符串作为默认值
```

### 3. 树木数据异常

```javascript
// 使用可选链操作符 (?.) 防止报错
a.center?.name;
```

## 与其他功能的兼容性

### 1. 计分系统 ✅

排序不影响计分,因为计分是基于树木数据,不依赖顺序。

### 2. 出牌逻辑 ✅

排序只影响显示,不影响游戏逻辑。

### 3. 特殊效果 ✅

紫木蜂等特殊效果仍然正常工作。

### 4. 数据同步 ✅

排序在客户端进行,不影响数据库存储。

## 总结

### 改进点

- ✅ **用户体验**: 森林显示更清晰
- ✅ **便于管理**: 相同树木排在一起
- ✅ **性能**: 无明显影响
- ✅ **兼容性**: 不影响现有功能

### 实现方式

- **简单**: 只需添加一个排序步骤
- **高效**: 使用原生 `sort()` 方法
- **可靠**: 使用 `localeCompare()` 正确处理中文

### 用户反馈预期

用户会发现森林显示更加有序,便于查看和规划策略。
