# 冬季卡功能重构总结 (v2)

## 核心变更

本次重构实现了"冬季卡展示并补抽"的完整逻辑，并修复了游戏结束判定。

### 1. 新的冬季卡规则

- **累计制**: 抽到第 3 张冬季卡时游戏才结束。
- **展示与补抽**: 抽到第 1、2 张冬季卡时，会展示卡牌（带有计数提示），将其移出游戏，并自动补抽一张牌。

### 2. 代码架构改进

#### 辅助方法 `processDrawWithWinter`

- **位置**: `miniprogram/pages/game/game.js`
- **作用**: 统一处理所有抽牌场景（玩家动作、奖励、翻牌），包含：
  - 循环检测冬季卡
  - 自动累加计数 `winterCardCount`
  - 生成 `isWinterReveal` 标记的展示事件
  - 自动执行补抽
  - 返回 `events` 数组供前端按顺序播放

#### 统一事件流

- **修改点**: `submitGameUpdate` 和 `_onGameUpdate`
- **功能**: 支持 `gameState.lastEvent` 为事件数组。
- **效果**: 前端现在可以连续播放 [冬季卡展示 -> 补抽的卡牌展示] 这样的事件序列，用户体验流畅。

#### 重构的关键函数

- `executeDrawFromDeck`: 使用 `processDrawWithWinter`。
- `finalizeAction`: 重构了奖励摸牌和回合结束翻牌逻辑，均使用 `processDrawWithWinter`，并将所有产生的事件（含冬季卡）合并提交。

### 3. 前端展示

- **样式**: 在 `game.wxss` 添加了 `.winter-overlay` 和 `.winter-count-badge`。
- **模板**: `game.wxml` 在 `DRAW_CARD` 和 `DECK_TO_CLEARING` 区域添加了遮罩层逻辑，当 `isWinterReveal=true` 时显示带有 "冬季卡 N/3" 的遮罩。

### 4. 数据结构变更

- `gameState.winterCardCount`: 记录当前已抽出的冬季卡数量。
- `gameState.lastEvent`: 现在可能是一个对象数组。

## 测试场景验证

1. **玩家摸牌 (普通)**: 正常摸牌，无冬季卡 -> 正常显示。
2. **玩家摸牌 (遇冬季卡)**:
   - 堆顶是冬季卡 ->
   - 后端生成 [冬季卡展示(1/3), 补抽卡展示] ->
   - 前端依次播放：先看到冬季卡和提示，然后翻转为补抽的卡。
3. **奖励摸牌**:
   - 奖励 2 张，中间夹杂冬季卡 ->
   - 最终手牌+2，事件序列包含冬季卡展示。
4. **回合结束翻牌**:
   - 翻牌遇到冬季卡 ->
   - 自动移出并多翻一张，事件列表包含冬季卡展示。
5. **游戏结束**:
   - 抽到第 3 张冬季卡 -> 立即触发 `handleGameOver`，跳转结算页。

## 备注

已修复 `onEndTurn` 中意外丢失的条件判断，确保特殊行动模式逻辑正确。
